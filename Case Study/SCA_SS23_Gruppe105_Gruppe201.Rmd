---
title: "Case Study - Gruppen 105 & 201"
subtitle: "Supply Chain Analytics SS23"
author: "Benjamin Grünwald, Cordelia Mena Hernandez, Daniel Glatter, Vinzenz Tom Andreas Schaak"
date: "2023-06-21"
output: pdf_document
header-includes:
  \usepackage{fvextra}
  \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines,commandchars=\\\{\}}
---

# Datenaufbereitung
```{r setup, include=FALSE}
# Laden von Packages
library(readxl)
library(tidyverse)
library(lubridate)
library(forecast)
library(zoo)
library(scales)
library(glue)
library(ggplot2)
library(Metrics)
library(knitr)
library(prophet)
opts_chunk$set(tidy.opts=list(width.cutoff=60),tidy=TRUE, echo = TRUE, warning = FALSE, message = FALSE)
```

```{r}
# Daten einlesen
materials <- read_excel("data/MBG_Materialverlauf_20230612.xlsx")

# Datentypen konvertieren
materials$ArtikelNr <- as.factor(materials$ArtikelNr)
materials$`Artikel-Bezeichnung` <- as.factor(materials$`Artikel-Bezeichnung`)
materials$EinAutDatTyp <- as.factor(materials$EinAutDatTyp)
materials$PjNr <- as.factor(materials$PjNr)
materials$PjInfo <- as.factor(materials$PjInfo)
materials$ORGAKzl <- as.factor(materials$ORGAKzl)
materials$EinAusDat <- as.Date(materials$EinAusDat)
materials$BstDat <- as.Date(materials$BstDat)

# Klassifizierung der Transaktionen: Projekt, Handel, Einkauf - nach Keywords
projekt <- c('PV-Realisierung', 'PV: Realisierung', 'PV: Tankstelle', 'PV: ET', 'PV: EDEKA', 'PV: MBG', 'PV: MO', 'PV: SolarSun', 'PV-Anlage: Realisierung', 'PV: 15,39', 'PV: 175x', 'PV: 99,83', 'PV: EFH')
handel <- c('PV-Materialverkauf', 'Groß- und')
einkauf <- c('Einkauf')

materials <- materials %>%
  mutate(klasse=if_else(grepl(paste(projekt, collapse='|'), PjInfo), "Projekt", if_else(grepl(paste(handel, collapse='|'), PjInfo), "Handel", if_else(grepl(paste(einkauf, collapse='|'), PjInfo), "Einkauf", "Anderes"))))

# Nur relevante Materialien für Gruppe B
materials_group_b <- c("DAS N-TOPcon Bifacial Glas-Glas (2+2mm) Black 415 WP",
                         "Rahmenloser Bildhalter Antireflexglas 29,7 x 42",
                         "Kabelbinder 280x4,5 mm schwarz",
                         "FPKU-EM-F PVC- Rohr grau EN50 L=3m",
                         "FINTECH Alu Steckrohr IESR 40 AL (3m)",
                         "3d-U-Scheiben     8,4   M 8         DIN 9021  A2")
materials_b <- materials %>%  filter(`Artikel-Bezeichnung` %in% materials_group_b)

materials_b
```

# Explorative Datenanalyse
## Deskriptive Statistiken
```{r}
# Anzahl Kunden
materials %>% filter(EinAutDatTyp != "geliefertAm") %>% select(ORGAKzl) %>% distinct() %>% count()
```

```{r}
# Anzahl Lieferanten
materials %>% filter(EinAutDatTyp == "geliefertAm") %>% select(ORGAKzl) %>% distinct() %>% count()
```

```{r}
# Anzahl Projekte
materials %>% select(PjInfo) %>% distinct() %>% count()
```
## Plot: Verteilung Projektklassen
```{r}
transaktion_klassiert <- materials %>% group_by(klasse) %>% count()

ggplot(transaktion_klassiert, aes(x=reorder(klasse, -n, sum), y=n, fill=klasse)) +
  geom_col() +
  theme(legend.position = "none") +
  ylab("Anzahl Transaktionen") +
  xlab("")

```


## Plot: Bestand über Zeit
```{r}
materials_b %>% 
  ggplot() +
  geom_line(aes(x=EinAusDat,y=Bestand,group=ArtikelNr, color=ArtikelNr
                ))

```

## Plot: Menge über Zeit
```{r}
materials_b %>% 
  ggplot() +
  geom_line(aes(x=EinAusDat,y=Menge,group=ArtikelNr, color=ArtikelNr
                ))
```

## Häufigkeit Materialien
```{r}
materials_b %>% group_by(`Artikel-Bezeichnung`) %>% count() %>% arrange(desc(n))
```

## Häufigkeit EinAusDatTyp
```{r}
materials_b %>% group_by(EinAutDatTyp) %>% count() %>% arrange(desc(n))
```

## Häufigkeiten EinAusDatTyp über alle Materialien
```{r}
materials %>% group_by(EinAutDatTyp) %>% count() %>% arrange(desc(n))
```

## Häufigkeit Projekte
```{r}
materials_b %>% group_by(PjInfo) %>% count() %>% arrange(desc(n))
```

## Plot: Mengen nach EinAusDatTyp
```{r}
materials_b %>% group_by(`Artikel-Bezeichnung`,EinAutDatTyp, month = lubridate::floor_date(EinAusDat, 'month')) %>%
  summarise(volume=sum(Menge)) %>%
  ggplot(aes(x=month,y=volume,group=EinAutDatTyp, color=EinAutDatTyp
                )) +
    geom_line() +
    facet_wrap(~`Artikel-Bezeichnung`, scales = 'free_y')
```

```{r}
# Einzelne Plots pro Artikel für Mengen nach EinAusDatTyp
library(sjPlot)
plots <- materials_b %>% group_by(`Artikel-Bezeichnung`) %>% nest %>% 
  mutate(plot = map2(
    data, `Artikel-Bezeichnung`, 
    ~ ggplot(data = .x, aes(x=EinAusDat,y=Menge,group=EinAutDatTyp, color=EinAutDatTyp)) +
      ggtitle(glue("{.y}")) +
      geom_line())) 

print(plots$plot)
```
## Plot: Korrigierter Bestand (cumsum)
```{r}
mat_verlauf <- materials_b %>%
  filter(EinAutDatTyp == "geliefertAm" | EinAutDatTyp == "BereitDat" | EinAutDatTyp == "PjPhaseDat") %>%
  group_by(`ArtikelNr`) %>%
  mutate(cum_sum = cumsum(Menge))
  

ggplot(data=mat_verlauf, aes(x=EinAusDat, y=cum_sum, fill=`ArtikelNr`)) +
    facet_wrap(~`Artikel-Bezeichnung`, nrow=3, scales="free_y") +
    geom_line() +
    xlab("Zeit") + 
    ylab("Materialmenge") +
    theme(legend.position = "none") +
    ggtitle("EinAutDatTyp = geliefertAm, BereitDat, PjPhaseDat")
```

## Differenzen der Menge zwischen Transaktionen
```{r}
materials_b <- materials_b %>%  group_by(ArtikelNr) %>%  mutate(Menge_diff = Menge - lag(Menge)) 
materials_b
```

```{r}
materials_b %>% 
  ggplot() +
  geom_line(aes(x=EinAusDat,y=Menge_diff,group=ArtikelNr, color=ArtikelNr
                ))
```
## Durchschnitte der Menge (Nachfrage und Lieferungen gemeinsam)
### Plot: Wochendurchschnitt der Menge
```{r}
# Berechnen des Durchschnitts nach Wochen

weekly_Menge <- materials_b %>%
  group_by(ArtikelNr, week = floor_date(EinAusDat, 'week')) %>%
  summarise(Menge_per_week= sum(Menge)) 

# Plot nach Wochen
weekly_Menge %>% 
  ggplot() +
  geom_line(aes(x=week,y=Menge_per_week, group=ArtikelNr, color=ArtikelNr
                ))
```

### Plot: Monatsdurchschnitt der Menge
```{r}
# Berechnen des Durchschnitts nach Monaten
monthly_mean <- weekly_Menge %>%  group_by(ArtikelNr, month=month(week)) %>%
  mutate(mean_Menge= mean(Menge_per_week))

monthly_mean %>% 
  ggplot() +
  geom_line(aes(x=month,y=mean_Menge, group=ArtikelNr, color=ArtikelNr
                ))
```

## Solarmodule
```{r}
solarmodul_artikel <- c("DAS N-TOPcon Bifacial Glas-Glas (2+2mm) Black 415 WP", "Panasonic VBHN300SJ46", "Q.PEAK DUO BLK-G9 340 Wp", "JAM54S30 - 410Wp/MR - Beistellung")
materials_solarmodule <- materials %>%
  filter(`Artikel-Bezeichnung` %in% solarmodul_artikel) %>%
  group_by(`ArtikelNr`) %>%
  mutate(cum_sum = cumsum(Menge))

ggplot(data=materials_solarmodule, aes(x=EinAusDat, y=cum_sum, fill=`ArtikelNr`)) +
    facet_wrap(~`Artikel-Bezeichnung`, nrow=2, scales="free_y") +
    geom_line() +
    xlab("Zeit") + 
    ylab("Materialmenge") +
    theme(legend.position = "none") +
    ggtitle("Verläufe Solarmodulbestand")
```

## Lieferanten
```{r}
lieferanten <- materials %>%
  filter(EinAutDatTyp == "geliefertAm") %>%
  group_by(Lieferant=ORGAKzl) %>%
  summarize(Anzahl_Bestellungen = n(),
            Anzahl_untersch_Materialien = n_distinct(`Artikel-Bezeichnung`),
            Lieferdauer = mean(EinAusDat - BstDat)) %>%
  arrange(desc(Anzahl_Bestellungen))

lieferanten
```


# Picks und Losgrößen
```{r}
picks <- materials_b %>% mutate(picks = if_else(Menge < 0, abs(Menge), 0), lot_size = if_else(Menge >= 0, abs(Menge), 0))
```

## Plot: Gepickte Menge (Nachfrage)
```{r}
picks %>% 
  ggplot() +
  geom_line(aes(x=EinAusDat,y=picks, group='Artikel-Bezeichnung', color=ArtikelNr, scale = 'free_y')) +
  ylab("Gepickte Menge")
```

## Plot: Gelieferte Menge/Losgröße (Lieferungen)
```{r}
picks %>% 
  ggplot() +
  geom_line(aes(x=EinAusDat,y=lot_size, group='Artikel-Bezeichnung', color=ArtikelNr, scale = 'free_y')) +
  ylab("Gelieferte Menge")
```

## Pickgröße vs. Bestell-Losgröße
```{r}
picks %>% filter(ArtikelNr == 29523, ) %>% 
  ggplot() +
  geom_line(aes(x=EinAusDat,y=picks, col= 'red')) +
  geom_line(aes(x=EinAusDat,y=lot_size, col='green'))
```

```{r}
picks %>% filter(ArtikelNr == 26535, ) %>% 
  ggplot() +
  geom_line(aes(x=EinAusDat,y=lot_size))
```

## Picks vs. Losgröße nach Artikel
```{r}
picks %>% filter(lot_size != 0) %>%
  ggplot(aes(x=lot_size)) +
  geom_histogram(colour="black", fill="white")+
  #geom_vline(data=picks %>% group_by(`Artikel-Bezeichnung`) %>% summarize(mean_lot_size=mean(lot_size, na.rm=TRUE)), aes(xintercept=mean_lot_size), color="red", linetype="dashed", size=0.75) +
  facet_wrap(~`Artikel-Bezeichnung`, scales="free") +
  # Text linksbündig
  theme(strip.text.x = element_text(hjust=0.0)) +
  ggtitle("Verteilung der Bestell-Losgrößen nach Artikel")
```

```{r}
picks %>% filter(ArtikelNr == 29523,lot_size !=0 ) %>% 
  ggplot(aes(x=lot_size)) +
  geom_histogram(binwidth=.1, colour="black", fill="white")+
  geom_vline(aes(xintercept=median(lot_size, na.rm=T)), color="red", linetype="dashed", size=1)
```

```{r}
picks %>% filter(ArtikelNr == 26535,lot_size !=0  ) %>%
  ggplot(aes(x=lot_size)) + 
  geom_histogram(binwidth=1,colour="black", fill="white") +
  geom_vline(aes(xintercept=median(lot_size, na.rm=T)), color="red", linetype="dashed", size=1)
```
```{r}
picks %>% filter(ArtikelNr == 21866,lot_size !=0  ) %>%
  ggplot(aes(x=lot_size)) + 
  geom_histogram(binwidth=1,colour="black", fill="white") +
  geom_vline(aes(xintercept=median(lot_size, na.rm=T)), color="red", linetype="dashed", size=1)
```
```{r}
picks %>% filter(ArtikelNr == 2628,lot_size !=0  ) %>%
  ggplot(aes(x=lot_size)) + 
  geom_histogram(binwidth=1,colour="black", fill="white") +
  geom_vline(aes(xintercept=median(lot_size, na.rm=T)), color="red", linetype="dashed", size=1)
```
```{r}
picks %>% filter(ArtikelNr == 26385,lot_size !=0  ) %>%
  ggplot(aes(x=lot_size)) + 
  geom_histogram(binwidth=1,colour="black", fill="white") +
  geom_vline(aes(xintercept=median(lot_size, na.rm=T)), color="red", linetype="dashed", size=1)
```
```{r}
picks %>% filter(ArtikelNr == 6203,lot_size !=0  ) %>%
  ggplot(aes(x=lot_size)) + 
  geom_histogram(binwidth=1,colour="black", fill="white") +
  geom_vline(aes(xintercept=median(lot_size, na.rm=T)), color="red", linetype="dashed", size=1)
```
```{r}
picks %>% filter(lot_size !=0) %>%  group_by(`Artikel-Bezeichnung`) %>% summarise(median_lot = median(lot_size))
```
```{r}
# Berechnen des Durchschnitts nach Wochen
weekly_picks <- picks %>%
  group_by(ArtikelNr, week = floor_date(EinAusDat, 'week')) %>%
  summarise(picks_per_week= sum(picks)) 
```

```{r}
weekly_avg_picks <- picks %>%
  group_by(ArtikelNr, week = floor_date(EinAusDat, 'week')) %>%
  summarise(avgpicks_per_week= mean(picks)) 
```


```{r}
weekly_meanpick <- weekly_picks %>%  group_by(ArtikelNr) %>%
  mutate(mean_pick = mean(picks_per_week))
```

```{r}
weekly_picks %>% 
  ggplot() +
  geom_line(aes(x=week ,y=picks_per_week, group= ArtikelNr, col= ArtikelNr))
```
```{r}
weekly_avg_picks %>% 
  ggplot() +
  geom_line(aes(x=week ,y=avgpicks_per_week, group= ArtikelNr, col= ArtikelNr))
```

# Zeitreihenanalyse
## Baseline-Modell (Durchschnitt)
```{r}
materials_b <- materials_b %>% group_by(ArtikelNr) %>% mutate(Baseline = mean(Menge))

evaluation = data.frame(Model = "Baseline",
                        MFE = numeric(1),
                        MAE = numeric(1),
                        MSE = numeric(1),
                        sMAPE = numeric(1))
# MFE berechnen
evaluation[evaluation$Model == "Baseline",] $MFE = mean(materials_b$Menge - materials_b$Baseline)

evaluation[evaluation$Model == "Baseline",] $MAE = mean(abs(materials_b$Menge - materials_b$Baseline))


evaluation[evaluation$Model == "Baseline",] $MSE = mean((materials_b$Menge - materials_b$Baseline)^2)


evaluation[evaluation$Model == "Baseline",] $sMAPE = smape(materials_b$Menge, materials_b$Baseline)

evaluation
```

## Gesamtmodell
```{r}
materials_B_aus <- materials_b %>%
  filter(Menge < 0) %>%
  mutate(cum_sum_aus = -cumsum(Menge)) %>%
  group_by(ArtikelNr, `Artikel-Bezeichnung`, month=as.yearmon(EinAusDat)) %>%
  summarize(menge_pro_monat= sum(-Menge))

mengen_3d_scheiben <- materials_B_aus[materials_B_aus$`Artikel-Bezeichnung` == "3d-U-Scheiben     8,4   M 8         DIN 9021  A2", "menge_pro_monat"]
ts_3d_Scheiben <- ts(mengen_3d_scheiben, frequency = 12)
plot.ts(ts_3d_Scheiben)

# Create model
m_3d_Scheiben <- ets(ts_3d_Scheiben, model="ZZZ")
m_3d_Scheiben

fcast_3d_Scheiben = forecast(m_3d_Scheiben, 12)

# DataFrame für Originaldaten
df_3d_Scheiben_orig = data.frame(
  period = seq(1, length(fcast_3d_Scheiben$x), 1), 
  bestand = as.numeric(fcast_3d_Scheiben$x), 
  group = rep("Original", length(fcast_3d_Scheiben$x)))

# DataFrame für Forecast erstellen (sowohl Vorhersage für Zeitreihenwerte als auch ein Jahr in die Zukunft)
df_3d_Scheiben_fcast = data.frame(
  period = seq(1, length(fcast_3d_Scheiben$fitted)+length(fcast_3d_Scheiben$mean), 1), 
  bestand = c(as.numeric(fcast_3d_Scheiben$fitted), as.numeric(fcast_3d_Scheiben$mean)), 
  group = rep("Modell", length(fcast_3d_Scheiben$fitted)+length(fcast_3d_Scheiben$mean)))

# In ein großes DataFrame zusammenführen
df_3d_Scheiben = rbind(df_3d_Scheiben_orig, df_3d_Scheiben_fcast)

# Plot
ggplot(df_3d_Scheiben, aes(x = period, y = bestand, colour = group)) +
  geom_line()+
  xlab("Periode") +
  ylab("Menge") +
  ggtitle("Gesamtmodell (Projekt + Großhandel)") +
  theme(legend.title = element_blank())
```

## Projektbetrieb
```{r}
materials_B_aus <- materials_b %>%
  filter(Menge < 0) %>%
  ## CHANGE MADE HERE ##
  filter(klasse == "Projekt") %>%
  mutate(cum_sum_aus = -cumsum(Menge)) %>%
  group_by(ArtikelNr, `Artikel-Bezeichnung`, month=as.yearmon(EinAusDat)) %>%
  summarize(menge_pro_monat= sum(-Menge))

mengen_3d_scheiben <- materials_B_aus[materials_B_aus$`Artikel-Bezeichnung` == "3d-U-Scheiben     8,4   M 8         DIN 9021  A2", "menge_pro_monat"]
ts_3d_Scheiben <- ts(mengen_3d_scheiben, frequency = 12)
plot.ts(ts_3d_Scheiben)

# Create model
m_3d_Scheiben <- ets(ts_3d_Scheiben, model="ZZZ")
m_3d_Scheiben

fcast_3d_Scheiben = forecast(m_3d_Scheiben, 12)

# DataFrame für Originaldaten
df_3d_Scheiben_orig = data.frame(
  period = seq(1, length(fcast_3d_Scheiben$x), 1), 
  bestand = as.numeric(fcast_3d_Scheiben$x), 
  group = rep("Original", length(fcast_3d_Scheiben$x)))

# DataFrame für Forecast erstellen (sowohl Vorhersage für Zeitreihenwerte als auch ein Jahr in die Zukunft)
df_3d_Scheiben_fcast = data.frame(
  period = seq(1, length(fcast_3d_Scheiben$fitted)+length(fcast_3d_Scheiben$mean), 1), 
  bestand = c(as.numeric(fcast_3d_Scheiben$fitted), as.numeric(fcast_3d_Scheiben$mean)), 
  group = rep("Modell", length(fcast_3d_Scheiben$fitted)+length(fcast_3d_Scheiben$mean)))

# In ein großes DataFrame zusammenführen
df_3d_Scheiben = rbind(df_3d_Scheiben_orig, df_3d_Scheiben_fcast)

# Plot
ggplot(df_3d_Scheiben, aes(x = period, y = bestand, colour = group)) +
  geom_line()+
  xlab("Periode") + 
  ylab("Menge") +
  ggtitle("Projektbasiert") +
  theme(legend.title = element_blank())
```

## Großhandel
```{r}
materials_B_aus <- materials_b %>%
  filter(Menge < 0) %>%
  ## CHANGE MADE HERE ##
  filter(klasse == "Handel") %>%
  mutate(cum_sum_aus = -cumsum(Menge)) %>%
  group_by(ArtikelNr, `Artikel-Bezeichnung`, month=as.yearmon(EinAusDat)) %>%
  summarize(menge_pro_monat= sum(-Menge))

mengen_3d_scheiben <- materials_B_aus[materials_B_aus$`Artikel-Bezeichnung` == "3d-U-Scheiben     8,4   M 8         DIN 9021  A2", "menge_pro_monat"]
ts_3d_Scheiben <- ts(mengen_3d_scheiben, frequency = 12)
plot.ts(ts_3d_Scheiben)

# Create model
m_3d_Scheiben <- ets(ts_3d_Scheiben, model="ZZZ")
m_3d_Scheiben

fcast_3d_Scheiben = forecast(m_3d_Scheiben, 12)

# DataFrame für Originaldaten
df_3d_Scheiben_orig = data.frame(
  period = seq(1, length(fcast_3d_Scheiben$x), 1), 
  bestand = as.numeric(fcast_3d_Scheiben$x), 
  group = rep("Original", length(fcast_3d_Scheiben$x)))

# DataFrame für Forecast erstellen (sowohl Vorhersage für Zeitreihenwerte als auch ein Jahr in die Zukunft)
df_3d_Scheiben_fcast = data.frame(
  period = seq(1, length(fcast_3d_Scheiben$fitted)+length(fcast_3d_Scheiben$mean), 1), 
  bestand = c(as.numeric(fcast_3d_Scheiben$fitted), as.numeric(fcast_3d_Scheiben$mean)), 
  group = rep("Modell", length(fcast_3d_Scheiben$fitted)+length(fcast_3d_Scheiben$mean)))

# In ein großes DataFrame zusammenführen
df_3d_Scheiben = rbind(df_3d_Scheiben_orig, df_3d_Scheiben_fcast)

# Plot
ggplot(df_3d_Scheiben, aes(x = period, y = bestand, colour = group)) +
  geom_line()+
  xlab("Periode") + 
  ylab("Menge") +
  ggtitle("Großhandel")  +
  theme(legend.title = element_blank())
```

# Reichweite
## Zeit bis zum ersten Pick
```{r}
# Reichweite bis 1. Pick = Zeit zwischen Bestelleingang (geliefertAm) und erster Transaktion (BereitDat, PjPhaseDat)
materials_b_1st_pick <- materials_b %>%
  # Nach Datum sortieren
  arrange(EinAusDat) %>%
  # Nach Material gruppieren
  group_by(ArtikelNr, `Artikel-Bezeichnung`) %>%
  mutate(bis_erster_pick = if_else(lead(EinAutDatTyp) %in% c("BereitDat", "PjPhaseDat"), as.numeric(difftime(lead(EinAusDat), EinAusDat, units="days")), NA)) %>%
  filter(EinAutDatTyp == "geliefertAm")
  # summarize(mean_bis_pick=mean(bis_erster_pick, na.rm=TRUE)) # NA remove for last entry

# Histogramm
ggplot(materials_b_1st_pick, aes(x=bis_erster_pick)) +
    geom_histogram(color="black", fill="white") +
    facet_wrap(~`Artikel-Bezeichnung`, scales = 'free') +
    # Text linksbündig
    theme(strip.text.x = element_text(hjust=0.0)) +
    ggtitle("Verteilung der Zeit von Bestelleingang bis zum ersten Pick [in Tagen]")

# Zeit zwischen Picks
# Mit WBZ gegenüberstellen
```

## Reichweite bis nächste Bestellung
```{r}
# = Zeit zwischen Bestelleingang und nächster Bestellung (BstDat -> wenn wir bestellen, nicht Eingang)
materials_b_n_bestellung <- materials_b %>%
  arrange(EinAusDat, ArtikelNr) %>%
  filter(EinAutDatTyp == "geliefertAm") %>%
  group_by(ArtikelNr, `Artikel-Bezeichnung`) %>%
  mutate(bis_n_bestl = as.numeric(difftime(lead(BstDat), EinAusDat, units="days")))
  # summarize(mean_bis_bestl=mean(bis_n_bestl, na.rm=TRUE)) # NA remove for last entry

# Histogramm
ggplot(materials_b_n_bestellung, aes(x=bis_n_bestl)) +
    geom_histogram(color="black", fill="white") +
    facet_wrap(~`Artikel-Bezeichnung`, scales = 'free') +
    # Text linksbündig
    theme(strip.text.x = element_text(hjust=0.0)) +
    ggtitle("Verteilung der Reichweite von Bestelleingang bis zur nächsten Bestellung [in Tagen]")
```

# Nachfrage aggregiert nach Zeit
## Tägliche Nachfrage
```{r}
# Nachfrage (Lagerausgänge = negative Werte) pro Tag
materials_b_tägl_menge <- materials_b %>%
  filter(Menge < 0) %>%
  group_by(EinAusDat, `Artikel-Bezeichnung`) %>%
  summarize(tägl_menge=-sum(Menge))

# 90% und 95% Perzentile
materials_b_tägl_menge %>%
  group_by(`Artikel-Bezeichnung`) %>%
  summarize(percentile_90 = quantile(tägl_menge, probs=0.9),
            percentile_95 = quantile(tägl_menge, probs=0.95))

# Histogramm
ggplot(materials_b_tägl_menge, aes(x=tägl_menge)) +
    geom_histogram(color="black", fill="white") +
    facet_wrap(~`Artikel-Bezeichnung`, scales = 'free') +
    # Text linksbündig
    theme(strip.text.x = element_text(hjust=0.0)) +
    ggtitle("Verteilung der täglichen Ausgangsmengen (Nachfrage)")
```

## Monatliche Nachfrage
```{r}
# Menge aggregiert auf Monatsebene (lassen sich Trends erkennen?)
materials_b_monatl_menge <- materials_b %>%
  filter(Menge < 0) %>%
  group_by(month=as.yearmon(EinAusDat), `Artikel-Bezeichnung`) %>%
  summarize(monatl_menge=-sum(Menge))

ggplot(data=materials_b_monatl_menge, aes(x=month, y=monatl_menge)) +
  geom_line() +
  facet_wrap(~`Artikel-Bezeichnung`, scales = 'free_y') +
  # Text linksbündig
  theme(strip.text.x = element_text(hjust=0.0)) +
  # Rotate Axis Ticks
  #theme(axis.text.x = element_text(angle = 90)) +
  ylab("Monatliche Nachfrage") +
  geom_smooth(method=lm)
```

# Wiederbeschaffungszeit (WBZ)
```{r}
WBZ_Daten <- materials_b %>% filter(EinAutDatTyp == "geliefertAm")
WBZ_Daten$WBZ <- WBZ_Daten$EinAusDat - WBZ_Daten$BstDat

# Nur positive WBZ (negative basieren auf fehlerhaften Transaktionen)
WBZ_Daten <- WBZ_Daten %>% filter(WBZ > 0)
WBZ_Daten[,c("ArtikelNr", "Artikel-Bezeichnung", "BstDat", "EinAusDat", "WBZ")]

# Histogramm
WBZ_Daten %>%
  ggplot(aes(x=WBZ)) +
  geom_histogram(color = "black", fill="white") +
  facet_wrap(~`Artikel-Bezeichnung`, scales = "free") +
  labs(x = "WBZ", y = "Anzahl") +
  ggtitle("WBZ für Materialien Gruppe B") #+ 
  geom_vline(aes(xintercept=mean(WBZ)),
            color="blue", linetype="dashed", size=1)

# Verteilungmasse
WBZ_Daten %>% 
  group_by(ArtikelNr, `Artikel-Bezeichnung`) %>%
  summarize(mean = mean(WBZ),
            median = median(WBZ),
            sd = sd(WBZ))
```

# Bestandsanalyse

```{r}
mat_verlauf <- materials_b %>%
  filter(EinAutDatTyp == "geliefertAm" | EinAutDatTyp == "BereitDat" | EinAutDatTyp == "PjPhaseDat") %>%
  group_by(`ArtikelNr`) %>%
  mutate(cum_sum = cumsum(Menge))
  
mat_verlauf %>% 
    ggplot() +
      geom_line(aes(x=EinAusDat, y=cum_sum, fill=`ArtikelNr`)) +
      facet_wrap(~`Artikel-Bezeichnung`, nrow=3, scales="free") +
      xlab("Zeit") + 
      ylab("Materialmenge") +
      theme(legend.position = "none") +
      ggtitle("EinAutDatTyp = geliefertAm, BereitDat, PjPhaseDat")
```

```{r}
b <- mat_verlauf %>% group_by(`Artikel-Bezeichnung`) %>% mutate(bestand_lagged = Menge + Bestand) %>% mutate(bestand_aprox = lag(bestand_lagged)) 
b %>% summarise(falscher_lagerbestand_prozent = sum(bestand_lagged == bestand_aprox, na.rm = TRUE)/n())
b %>% ggplot(aes(x =EinAusDat)) +
  geom_line(aes(y=Bestand, color= "Bestand")) + geom_line(aes(y=bestand_aprox, color= "(Bestand + Menge) lagged")) +
  facet_wrap(~`Artikel-Bezeichnung`, nrow=3, scales="free") 
```
Wir können sehen dass an gewissen Punkten Lagerbestände falsch angegeben sind. Dies kann man dadurch belegen, dass bei Warenausgang oder Wareneingang, der Bestand in der nächste Transaktion dem vorherigen um die Veränderung entsprechen muss.


```{r}
ordered_quantity <- mat_verlauf %>% filter(EinAutDatTyp =='geliefertAm')
ordered_quantity %>%
  select(ArtikelNr, BstDat,) %>% left_join(mat_verlauf %>%
  select(EinAusDat,EinAutDatTyp, `Artikel-Bezeichnung`,Menge, Bestand, cum_sum) %>%
  filter(Menge<0) , join_by(ArtikelNr, closest(BstDat >= EinAusDat))) %>%
  drop_na() %>%
  ggplot()+ geom_histogram(aes(x=cum_sum, fill ="Cumsum")) + geom_histogram(aes(x= Bestand, fill ="Bestand")) + facet_wrap(~`Artikel-Bezeichnung`, nrow=3, scales="free")
```



```{r}
picks_between_order <- mat_verlauf %>% group_by(`Artikel-Bezeichnung`) %>% arrange(EinAusDat, .by_group = TRUE) %>%  fill(BstDat, .direction = "up",) %>%  filter(Menge<0) %>% group_by(`Artikel-Bezeichnung`, BstDat) %>% summarise(pick_quantity_between_orders = sum(abs(Menge)))

ggplot() + geom_line(aes(x= BstDat, y = pick_quantity_between_orders ,color="Picks"), data=picks_between_order)  + geom_point(aes(x= BstDat, y = pick_quantity_between_orders,color="Picks"), data =picks_between_order ,) +
  geom_line(aes(x= BstDat, y = Menge,color= "Bestellte_menge"), data=ordered_quantity) +
  geom_point(aes(x= BstDat, y = Menge, ,color= "Bestellte_menge"), data=ordered_quantity) +
  facet_wrap(~`Artikel-Bezeichnung`, nrow=3, scales="free") 


```
Der Plot stellt die Summe der Picks bevor einer Bestellung in Vergleich zur bestellten Menge dar. Man sieht das die Summe der Picks vor der Bestellung oft weit über der bestellten Menge liegen, das lässt auf größere Infeziente Lagerhaltung schliesen.


```{r}
picks_cum_sum_between_order <- mat_verlauf %>% select(ArtikelNr,`Artikel-Bezeichnung`,EinAusDat, BstDat,Menge, ) %>% group_by(`Artikel-Bezeichnung`) %>% arrange(EinAusDat, .by_group = TRUE) %>%  fill(BstDat, .direction = "up",) %>%  filter(Menge<0) %>% group_by(`Artikel-Bezeichnung`, BstDat) %>% mutate(pick_cum_sum_between_orders = cumsum(abs(Menge)))


ordered_quantity %>% select(ArtikelNr, BstDat, `Artikel-Bezeichnung`) %>% left_join(picks_cum_sum_between_order, join_by(ArtikelNr, closest(BstDat >= EinAusDat))) %>% ggplot()+ geom_histogram(aes(x=pick_cum_sum_between_orders, fill ="Cumsum_picks")) + facet_wrap(~`Artikel-Bezeichnung.x`, nrow=3, scales="free") 
```

Der Plot zeigt die Verteilung der cumulierten Summe der Picks dar am Bestelltag der nächsten Bestellung. Dadurch dass der Wert nicht eindeutig ist, schiließen wir das der Logistiker kein eindeutigen Bestellmenge* hat

# Sicherheitsbestand
```{r}
# Parameter
perzentil_meldebestand <- 0.5
perzentil_nachfrage <- 0.9
perzentil_wbz <- 0.9

# Erstellung DataFrame
# Meldebestand
meldebestand <- mat_verlauf %>%
  filter(EinAutDatTyp =='geliefertAm') %>%
  select(ArtikelNr, BstDat,) %>%
  left_join(
    mat_verlauf %>%
    select(EinAusDat,EinAutDatTyp, `Artikel-Bezeichnung`,Menge, Bestand, cum_sum) %>%
    filter(Menge<0) , join_by(ArtikelNr, closest(BstDat >= EinAusDat))
  ) %>%
  drop_na() %>%
  group_by(`Artikel-Bezeichnung`) %>%
  summarize(Meldebestand_quantile = quantile(Bestand, probs=perzentil_meldebestand))

# Tägliche Nachfrage
tägl_nachfrage <- materials_b_tägl_menge %>% group_by(`Artikel-Bezeichnung`) %>% summarize(Nachfrage_quantile=quantile(tägl_menge, perzentil_nachfrage))

# WBZ in Tagen
wbz <- WBZ_Daten %>% group_by(`Artikel-Bezeichnung`) %>% summarize(WBZ_quantile=quantile(WBZ, perzentil_wbz))

sicherheitsbestand <- data.frame(unique(materials_b$`Artikel-Bezeichnung`))
colnames(sicherheitsbestand) <- c("Artikel-Bezeichnung")

sicherheitsbestand <- inner_join(sicherheitsbestand, meldebestand, by="Artikel-Bezeichnung")
sicherheitsbestand <- inner_join(sicherheitsbestand, tägl_nachfrage, by="Artikel-Bezeichnung")
sicherheitsbestand <- inner_join(sicherheitsbestand, wbz, by="Artikel-Bezeichnung")

# Sicherheitsbestand berechnen
sicherheitsbestand <- sicherheitsbestand %>%
  mutate(sicherheitsbestand = as.numeric(Meldebestand_quantile - Nachfrage_quantile * WBZ_quantile))

sicherheitsbestand
```
