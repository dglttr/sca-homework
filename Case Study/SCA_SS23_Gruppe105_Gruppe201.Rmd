---
title: "Case Study - Gruppen 105 & 201"
subtitle: "Supply Chain Analytics SS23"
author: "Benjamin Grünwald, Cordelia Mena Hernandez, Daniel Glatter, Vinzenz Tom Andreas Schaak"
date: "2023-06-21"
output: pdf_document
header-includes:
  \usepackage{fvextra}
  \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines,commandchars=\\\{\}}
---

# Phase 2: Datenbeschaffung/Einlesen
```{r setup, include=FALSE}
# Laden von Packages
library(readxl)
library(tidyverse)
library(lubridate)
library(forecast)
library(zoo)
library(scales)
library(glue)
library(ggplot2)
library(sjPlot)
library(Metrics)
library(knitr)
library(purrr)
library(treemap)
opts_chunk$set(tidy.opts=list(width.cutoff=60),tidy=TRUE, echo = TRUE, warning = FALSE, message = FALSE)
```

```{r}
# Daten einlesen
materials <- read_excel("data/MBG_Materialverlauf_20230612.xlsx")

# Datentypen konvertieren
materials$ArtikelNr <- as.factor(materials$ArtikelNr)
materials$`Artikel-Bezeichnung` <- as.factor(materials$`Artikel-Bezeichnung`)
materials$EinAutDatTyp <- as.factor(materials$EinAutDatTyp)
materials$PjNr <- as.factor(materials$PjNr)
materials$PjInfo <- as.factor(materials$PjInfo)
materials$ORGAKzl <- as.factor(materials$ORGAKzl)
materials$EinAusDat <- as.Date(materials$EinAusDat)
materials$BstDat <- as.Date(materials$BstDat)

# Klassifizierung der Transaktionen: Projekt, Handel, Einkauf - nach Keywords
projekt <- c('PV-Realisierung', 'PV: Realisierung', 'PV: Tankstelle', 'PV: ET', 'PV: EDEKA', 'PV: MBG', 'PV: MO', 'PV: SolarSun', 'PV-Anlage: Realisierung', 'PV: 15,39', 'PV: 175x', 'PV: 99,83', 'PV: EFH')
handel <- c('PV-Materialverkauf', 'PV: Materialverkauf', 'PV Materialverkauf')
einkauf <- c('Einkauf', 'Groß- und Einzelhandel der MBG')

materials <- materials %>%
  mutate(klasse=if_else(grepl(paste(projekt, collapse='|'), PjInfo), "Projekt", if_else(grepl(paste(handel, collapse='|'), PjInfo), "Handel", if_else(grepl(paste(einkauf, collapse='|'), PjInfo), "Einkauf", "Anderes"))))
materials$klasse <- as.factor(materials$klasse)

# Nur relevante Materialien für Gruppe B
materials_group_b <- c("DAS N-TOPcon Bifacial Glas-Glas (2+2mm) Black 415 WP",
                         "Rahmenloser Bildhalter Antireflexglas 29,7 x 42",
                         "Kabelbinder 280x4,5 mm schwarz",
                         "FPKU-EM-F PVC- Rohr grau EN50 L=3m",
                         "FINTECH Alu Steckrohr IESR 40 AL (3m)",
                         "3d-U-Scheiben     8,4   M 8         DIN 9021  A2")
materials_b <- materials %>%  filter(`Artikel-Bezeichnung` %in% materials_group_b)

materials_b %>% filter(`Artikel-Bezeichnung`=="3d-U-Scheiben     8,4   M 8         DIN 9021  A2", EinAutDatTyp=="geliefertAm") %>% group_by(mon=as.yearmon(EinAusDat)) %>% count() %>% ggplot(aes(x=mon, y=n))+geom_col()
```

# Phase 3: Explorative Datenanalyse
## Deskriptive Statistiken
```{r}
# Anzahl Kunden
materials %>% filter(EinAutDatTyp != "geliefertAm") %>% select(ORGAKzl) %>% distinct() %>% count()
```

```{r}
# Anzahl Lieferanten
materials %>% filter(EinAutDatTyp == "geliefertAm") %>% select(ORGAKzl) %>% distinct() %>% count()
```

```{r}
# Anzahl Projekte
materials %>% select(PjInfo) %>% distinct() %>% count()
```

```{r}
# Anzahl Materialien
materials %>% select(`Artikel-Bezeichnung`) %>% distinct() %>% count()
```

## Plot: Transaktionen nach Zeit
```{r}
# Aggregiert auf Monate
materials %>% group_by(Month=as.yearmon(EinAusDat)) %>% summarize(cnt=n()) %>% mutate(future=ifelse(Month > as.yearmon("2023-06-12"), "Future", "Past")) %>%
  ggplot(aes(x=Month, y=cnt, fill=future)) +
  geom_col()+
  labs(x="Zeit", y="Anzahl monatl. Transaktionen")+
  scale_fill_manual(values=c("darkgrey", "black"))+
  theme(legend.position="none")+
  #geom_vline(aes(xintercept=as.yearmon("2023-06-12")), color="blue", linetype="dashed", size=0.75)
  geom_smooth(data=materials %>% filter(EinAusDat <= "2023-06-12") %>% group_by(Month=as.yearmon(EinAusDat)) %>% summarize(cnt=n()) %>% mutate(future=ifelse(Month > as.yearmon("2023-06-12"), "Future", "Past")), method=lm, se=FALSE, color="#C50E1F", size=1.5)+
   ylim(0, NA)
```

```{r}
# Aggregiert auf Tage
materials %>% group_by(Day=EinAusDat) %>% summarize(cnt=n()) %>% mutate(future=ifelse(Day > "2023-06-12", "Future", "Past")) %>%
  ggplot(aes(x=Day, y=cnt, fill=future)) +
  geom_col()+
  labs(x="Zeit", y="Anzahl täglicher Transaktionen")+
  scale_fill_manual(values=c("darkgrey", "black"))+
  theme(legend.position="none")+
  #geom_vline(aes(xintercept=as.yearmon("2023-06-12")), color="blue", linetype="dashed", size=0.75)
  geom_smooth(data=materials %>% filter(EinAusDat <= "2023-06-12") %>% group_by(Day=EinAusDat) %>% summarize(cnt=n()) %>% mutate(future=ifelse(Day > as.yearmon("2023-06-12"), "Future", "Past")), method=lm, se=FALSE)+
   ylim(0, NA)
```

## Plot: Verteilung Projektklassen
```{r}
transaktion_klassiert <- materials %>% group_by(klasse) %>% count()

ggplot(transaktion_klassiert, aes(y=reorder(klasse, n, sum), x=n, fill=klasse)) +
  geom_col() +
  theme(legend.position = "none") +
  ylab("Anzahl Transaktionen") +
  xlab("")+
  scale_fill_manual(values=c("Handel" = "#2A2AD5",
                             "Projekt" = "#FF8000",
                             "Einkauf" = "#00FFFF", 
                             "Anderes" = "grey"))

```

## Materialien
### Häufigkeit Materialien
```{r}
# Treemap
materials_agg <- materials %>% group_by(`Artikel-Bezeichnung`) %>% summarize(cnt=n(), gesamtnachfrage=sum(ifelse(Menge<0, -Menge, 0)))

treemap(materials_agg, index="Artikel-Bezeichnung", vSize="cnt", vColor="gesamtnachfrage", palette="Blues", type="value", border.lwds=0.2)
```

```{r}
# Transaktionen nach Material
agg <- materials %>% group_by(`Artikel-Bezeichnung`) %>% count() %>% arrange(desc(n)) %>% mutate(`Artikel-Bezeichnung` = substring(`Artikel-Bezeichnung`, 0, 50))

# Plot 1: Materialien nach Anzahl Transaktionen
ggplot(agg, aes(x=reorder(`Artikel-Bezeichnung`, -n), y=n))+
  geom_col(color="black")+
  labs(y="Anzahl Transaktionen", x="Materialien")+
  theme(axis.ticks.x=element_blank(), axis.text.x=element_blank(),
        panel.grid.major.x=element_blank(), panel.grid.major.y=element_blank())

# Plot 2: In Buckets einsortieren
agg %>% mutate(Gruppe=cut(n, breaks=c(0, 5, 10, 20, 50, 100, 200, 500, 1000, 2000))) %>% group_by(Gruppe) %>% count() %>%
  ggplot(aes(x=Gruppe, y=n))+
  geom_col()

# Plot 3: Scatter Plot der Gruppen
materials %>% group_by(`Artikel-Bezeichnung`) %>% summarize(n_trans=n()) %>% group_by(n_trans) %>% summarize(n_materialien_je_n_trans=n(), first_mat=first(`Artikel-Bezeichnung`)) %>%
  arrange(desc(n_trans), n_materialien_je_n_trans) %>%
  ggplot(aes(x=n_trans, y=n_materialien_je_n_trans, label=first_mat))+
  geom_point()+
  labs(x="Anzahl Transaktionen", y="Anzahl Materialien")
  #geom_text(data=materials %>% group_by(`Artikel-Bezeichnung`) %>% summarize(n_trans=n()) %>% group_by(n_trans) %>% summarize(n_materialien_je_n_trans=n(), first_mat=first(`Artikel-Bezeichnung`)) %>% arrange(desc(n_trans), n_materialien_je_n_trans) %>% nth(1), check_overlap = TRUE)
```

### Anzahl unterschiedlicher Materialien pro Monat
```{r}
# Anzahl unterschiedlicher Materialien (pro Monat)
materials %>% group_by(mon=as.yearmon(EinAusDat)) %>% summarize(anz_mat=n_distinct(`Artikel-Bezeichnung`)) %>%
  mutate(future=ifelse(mon > as.yearmon("2023-06-12"), "Future", "Past")) %>%
  ggplot(aes(x=mon, y=anz_mat, fill=future))+geom_col()+
  scale_fill_manual(values=c("darkgrey", "black"))+
  theme(legend.position="none")+
  labs(x="", y="Anzahl unterschiedlicher Materialien (pro Monat)")

# Summary der Menge und Bestand 
summary(materials[, c("Menge", "Bestand")])

# Anzahl aller Transaktionen pro Menge
materials %>% group_by(Menge) %>% count() %>%
  ggplot(aes(x=Menge))+
  geom_histogram()+
  labs(y="Anzahl Transaktionen")

# Histogram des Bestands
materials %>% group_by(Bestand) %>% count() %>%
  ggplot(aes(x=Bestand))+
  geom_histogram()
```

## EinAutDatTyp
### Häufigkeit EinAusDatTyp
```{r}
materials %>% group_by(EinAutDatTyp) %>% count() %>% arrange(desc(n))
```

### Häufigkeiten EinAusDatTyp über alle Materialien
```{r}
materials %>% group_by(EinAutDatTyp) %>% count() %>% arrange(desc(n))
```

## Projekte
### Häufigkeiten Projekte
```{r}
materials %>% group_by(PjInfo) %>% count() %>% arrange(desc(n))
```

### Plot: Mengen nach EinAusDatTyp
```{r}
materials_b %>% group_by(`Artikel-Bezeichnung`,EinAutDatTyp, month = lubridate::floor_date(EinAusDat, 'month')) %>%
  summarise(volume=sum(Menge)) %>%
  ggplot(aes(x=month,y=volume,group=EinAutDatTyp, color=EinAutDatTyp
                )) +
    geom_line() +
    facet_wrap(~`Artikel-Bezeichnung`, scales = 'free_y')
```

```{r}
# Einzelne Plots pro Artikel für Mengen nach EinAusDatTyp
plots <- materials_b %>% group_by(`Artikel-Bezeichnung`) %>% nest %>% 
  mutate(plot = map2(
    data, `Artikel-Bezeichnung`, 
    ~ ggplot(data = .x, aes(x=EinAusDat,y=Menge,group=EinAutDatTyp, color=EinAutDatTyp)) +
      ggtitle(glue("{.y}")) +
      geom_line())) 

print(plots$plot)
```

### Plot: Top Projekte
```{r}
# Top 15 Projekte
materials %>% group_by(PjInfo, klasse) %>% count() %>% arrange(desc(n)) %>% mutate(PjInfo=substring(PjInfo, 0, 40)) %>% head(15) %>% ggplot(aes(x=n, y=reorder(PjInfo, n)))+
  geom_col()+
  theme(legend.position="none", axis.ticks.y=element_blank())+
  labs(x="Anzahl Transaktionen", y="Projekt-Info")+
  scale_fill_manual(values=c("Handel" = "#2A2AD5",
                             "Projekt" = "#FF8000",
                             "Einkauf" = "#00FFFF", 
                             "Anderes" = "grey"))
```
## Menge
### Plot: Menge über Zeit
```{r}
materials_b %>% 
  ggplot() +
  geom_line(aes(x=EinAusDat,y=Menge,group=`Artikel-Bezeichnung`, color=`Artikel-Bezeichnung`
                ))+
  xlab('Datum')+
  ggtitle('Menge über die Zeit')+
  theme(legend.title = element_text(size = 5), 
               legend.text = element_text(size = 5))
```

### Plot: Mengen nach klasse und Material
```{r}
materials_b %>% filter(Menge < 0) %>% group_by(`Artikel-Bezeichnung`, EinAusDat, klasse) %>% summarize(Nachfrage=sum(-Menge)) %>%
  ggplot(aes(x=EinAusDat,y=Nachfrage,group=klasse, color=klasse)) +
    geom_line() +
    # Text linksbündig
    theme(strip.text.x = element_text(hjust=0.0)) +
    facet_wrap(~`Artikel-Bezeichnung`, scales = 'free_y')
```

### Plot: Korrigierter Bestand (cumsum)
```{r}
mat_verlauf <- materials_b %>%
  filter(EinAutDatTyp == "geliefertAm" | EinAutDatTyp == "BereitDat" | EinAutDatTyp == "PjPhaseDat") %>%
  group_by(`ArtikelNr`) %>%
  mutate(cum_sum = cumsum(Menge))
  

ggplot(data=mat_verlauf, aes(x=EinAusDat, y=cum_sum, fill=`ArtikelNr`)) +
    facet_wrap(~`Artikel-Bezeichnung`, nrow=3, scales="free_y") +
    geom_line() +
    xlab("Zeit") + 
    ylab("Materialmenge") +
    theme(legend.position = "none") +
    ggtitle("EinAutDatTyp = geliefertAm, BereitDat, PjPhaseDat")
```
## Durchschnitte der Menge (Nachfrage und Lieferungen gemeinsam)
### Plot: Wochendurchschnitt der Menge
```{r}
# Berechnen des Durchschnitts nach Wochen

weekly_Menge <- materials_b %>%
  group_by(`Artikel-Bezeichnung`, week = floor_date(EinAusDat, 'week')) %>%
  summarise(Menge_per_week= sum(Menge)) 

# Plot nach Wochen
weekly_Menge %>% 
  ggplot() +
  geom_line(aes(x=week,y=Menge_per_week, group=`Artikel-Bezeichnung`, color=`Artikel-Bezeichnung`
                ))
```

### Plot: Monatsdurchschnitt der Menge
```{r}
# Berechnen des Durchschnitts nach Monaten
monthly_mean <- weekly_Menge %>%  group_by(`Artikel-Bezeichnung`, month=month(week)) %>%
  mutate(mean_Menge= mean(Menge_per_week))

# Plot Monatsdurchschnitt
monthly_mean %>% 
  ggplot() +
  geom_line(aes(x=month,y=mean_Menge, group=`Artikel-Bezeichnung`, color=`Artikel-Bezeichnung`
                ))
```

## Vergleich Solarmodule
```{r}
solarmodul_artikel <- c("DAS N-TOPcon Bifacial Glas-Glas (2+2mm) Black 415 WP", "Panasonic VBHN300SJ46", "Q.PEAK DUO BLK-G9 340 Wp", "JAM54S30 - 410Wp/MR - Beistellung")

ggplot(data=materials %>% filter(`Artikel-Bezeichnung` %in% solarmodul_artikel),
  aes(x=EinAusDat, y=Bestand, fill=`ArtikelNr`)) +
    facet_wrap(~`Artikel-Bezeichnung`, nrow=2, scales="free_y") +
    geom_line() +
    xlab("Zeit") + 
    ylab("Bestand") +
    theme(legend.position = "none") +
    ggtitle("Verläufe Solarmodulbestand")+
  # Text linksbündig
  theme(strip.text.x = element_text(hjust=0.0))
```

## Lieferanten
```{r}
# Lieferanten Dataframe erstellen
lieferanten <- materials %>%
  filter(EinAutDatTyp == "geliefertAm") %>%
  group_by(Lieferant=ORGAKzl) %>%
  summarize(Anzahl_Bestellungen = n(),
            Anzahl_untersch_Materialien = n_distinct(`Artikel-Bezeichnung`),
            Lieferdauer = as.numeric(mean(EinAusDat - BstDat))) %>%
  mutate(Anteil_Bestellungen = Anzahl_Bestellungen/sum(Anzahl_Bestellungen)) %>%
  arrange(desc(Anzahl_Bestellungen))
```

```{r}
# Treemap von Lieferanten
treemap(lieferanten, index="Lieferant", vSize="Anzahl_Bestellungen", vColor="Lieferdauer", type="value", palette="-RdYlGn", border.col="grey", border.lwds = 0.2)
```


## Kunden
```{r}
# Tabelle
mymode <- function(x) {
                t <- table(x)
                names(t)[ which.max(t) ]
          }

kunden <- materials %>%
  filter(Menge < 0) %>%
  group_by(Kunde=ORGAKzl) %>%
  summarize(Anzahl_Transaktionen = n(),
            Anzahl_Projekte = n_distinct(PjNr),
            Kunde_seit = min(EinAusDat, na.rm=TRUE),
            Geschäftsbereich=mymode(klasse)) %>%
  arrange(desc(Anzahl_Transaktionen))

# Plot der Kundenalter
kunden %>% mutate(kunde_seit_tagen=as.numeric(today()-Kunde_seit)) %>%
  ggplot()+geom_histogram(aes(x=kunde_seit_tagen))
```

```{r}
# Plot: Gegenüberstellung der Anzahl der Projekte und Transaktionen
ggplot(kunden, aes(x=Anzahl_Transaktionen, y=Anzahl_Projekte, label=Kunde, color=Geschäftsbereich))+
  geom_point(show.legend = FALSE)+
  geom_text(hjust=0.5, vjust=1, nudge_y=-15, check_overlap=TRUE)+
  labs(x="Anzahl Transaktionen", y="Anzahl Projekte")+
  scale_color_manual(values=c("Handel" = "#2A2AD5",
                             "Projekt" = "#FF8000",
                             "Einkauf" = "#00FFFF", 
                             "Anderes" = "grey"))+
  geom_point(size = -1, aes(fill = Geschäftsbereich)) +
  theme(legend.position=c(.13, .78))
```

## Datenqualität
```{r}
# Stimmen ArtikelNr und Bezeichnung immer überein? -> Ja
materials %>% group_by(`Artikel-Bezeichnung`) %>% summarize(a=n_distinct(ArtikelNr)) %>% arrange(desc(a))

# Zeile ohne EinAusDat
materials %>% filter(is.na(EinAusDat)) %>% select(EinAusDat, BstDat, ORGAKzl, Menge, `Artikel-Bezeichnung`)

# Zeilen mit Ausreißern
materials %>% filter(Menge < -15000)
```

## Bestand
### Plot: Bestand über Zeit
```{r}
materials_b %>% 
  ggplot() +
  geom_line(aes(x=EinAusDat,y=Bestand,group=`Artikel-Bezeichnung`, color=`Artikel-Bezeichnung`
                ))+
  xlab('Datum')+
  ggtitle('Lagerbestand über die Zeit')

ggplot(data=materials_b, aes(x=EinAusDat, y=Bestand)) +
    facet_wrap(~`Artikel-Bezeichnung`, nrow=3, scales="free_y") +
    geom_line() +
    xlab("Zeit") + 
    ylab("Bestand") +
    theme(legend.position = "none")

```
## Bestand
### Plot: Menge über Zeit
```{r}
mat_verlauf <- materials_b %>%
  filter(EinAutDatTyp == "geliefertAm" | EinAutDatTyp == "BereitDat" | EinAutDatTyp == "PjPhaseDat") %>%
  group_by(`ArtikelNr`) %>%
  mutate(cum_sum = cumsum(Menge))
  
mat_verlauf %>% 
    ggplot() +
      geom_line(aes(x=EinAusDat, y=cum_sum, fill=`ArtikelNr`)) +
      facet_wrap(~`Artikel-Bezeichnung`, nrow=3, scales="free") +
      xlab("Zeit") + 
      ylab("Materialmenge") +
      theme(legend.position = "none") +
      ggtitle("EinAutDatTyp = geliefertAm, BereitDat, PjPhaseDat")
```
# Überprüfung des Bestands auf Integrität
```{r}
b <- mat_verlauf %>% group_by(`Artikel-Bezeichnung`) %>%  filter(klasse=='Handel') %>% mutate(bestand_lagged = Menge + Bestand ) %>% mutate(bestand_aprox = lag(bestand_lagged)) 
b %>% summarise(falscher_lagerbestand_prozent = sum(bestand_lagged == bestand_aprox, na.rm = TRUE)/n(), falscher_lagerbestand_prozent_cum_sum = sum(cum_sum == bestand_aprox, na.rm = TRUE)/n())
b %>% ggplot(aes(x =EinAusDat)) +
  geom_line(aes(y=Bestand, color= "Bestand")) + geom_line(aes(y=bestand_aprox, color= "(Bestand + Menge) lagged")) +
  geom_line(aes(y=cum_sum, color= "cum_sum"))+
  facet_wrap(~`Artikel-Bezeichnung`, nrow=3, scales="free") 
```
Wir können sehen dass an gewissen Punkten Lagerbestände falsch angegeben sind. Dies kann man dadurch belegen, dass bei Warenausgang oder Wareneingang, der Bestand in der nächste Transaktion dem vorherigen um die Veränderung entsprechen muss.

# Abrufmenge bis zum nächsten Bestellpunkt
```{r}
# Letzter Abruf vor jeder Bestellung mit as_of_join bestimmt 
ordered_quantity <- mat_verlauf %>% filter(EinAutDatTyp =='geliefertAm')
ordered_quantity %>%
  select(ArtikelNr, BstDat,) %>% left_join(mat_verlauf %>%
  select(EinAusDat,EinAutDatTyp, `Artikel-Bezeichnung`,Menge, Bestand, cum_sum) %>%
  filter(Menge<0) , join_by(ArtikelNr, closest(BstDat >= EinAusDat))) %>%
  drop_na() %>%
  ggplot()+ geom_histogram(aes(x=cum_sum, fill ="Cumsum")) + geom_histogram(aes(x= Bestand, fill ="Bestand")) + facet_wrap(~`Artikel-Bezeichnung`, nrow=3, scales="free")
```
# Summe der Picks zwischen zwei Bestellzeitpunkten
```{r}
picks_between_order <- mat_verlauf %>% group_by(`Artikel-Bezeichnung`) %>% arrange(EinAusDat, .by_group = TRUE) %>%  fill(BstDat, .direction = "up",) %>%  filter(Menge<0) %>% group_by(`Artikel-Bezeichnung`, BstDat) %>% summarise(pick_quantity_between_orders = sum(abs(Menge)))

ggplot() + geom_line(aes(x= BstDat, y = pick_quantity_between_orders ,color="Picks"), data = picks_between_order)  + geom_point(aes(x= BstDat, y = pick_quantity_between_orders,color="Picks"), data = picks_between_order ,) +
  geom_line(aes(x= BstDat, y = Menge,color= "Bestellte_menge"), data=ordered_quantity) +
  geom_point(aes(x= BstDat, y = Menge, ,color= "Bestellte_menge"), data=ordered_quantity) +
  facet_wrap(~`Artikel-Bezeichnung`, nrow=3, scales="free") 
```
Der Plot stellt die Summe der Picks bevor einer Bestellung in Vergleich zur bestellten Menge dar. Man sieht das die Summe der Picks vor der Bestellung oft weit über der bestellten Menge liegen, das lässt auf größere Infeziente Lagerhaltung schliesen.

# Kummulierte Summe der Abrufe zwischen Bestellungen als Histogram
```{r}
picks_cum_sum_between_order <- mat_verlauf %>% select(ArtikelNr,`Artikel-Bezeichnung`,EinAusDat, BstDat,Menge, ) %>% group_by(`Artikel-Bezeichnung`) %>% arrange(EinAusDat, .by_group = TRUE) %>%  fill(BstDat, .direction = "up",) %>%  filter(Menge<0) %>% group_by(`Artikel-Bezeichnung`, BstDat) %>% mutate(pick_cum_sum_between_orders = cumsum(abs(Menge)))


nachf_in_WBZ <- ordered_quantity %>% select(ArtikelNr, BstDat, `Artikel-Bezeichnung`) %>% left_join(picks_cum_sum_between_order, join_by(ArtikelNr, closest(BstDat >= EinAusDat)))
  
ggplot(nachf_in_WBZ)+ geom_histogram(aes(x=pick_cum_sum_between_orders, fill ="Cumsum_picks")) + facet_wrap(~`Artikel-Bezeichnung.x`, nrow=3, scales="free")

nachf_in_WBZ %>% group_by(ArtikelNr) %>% summarize(quantile(pick_cum_sum_between_orders, 0.9, na.rm=TRUE))
```

Der Plot zeigt die Verteilung der cumulierten Summe der Picks dar am Bestelltag der nächsten Bestellung. Dadurch dass der Wert nicht eindeutig ist, schiließen wir das der Logistiker kein eindeutigen Bestellmenge* hat.

## Picks und Losgrößen
```{r}
picks <- materials_b %>% mutate(picks = if_else(Menge < 0, -Menge, 0), lot_size = if_else(Menge >= 0, abs(Menge), 0))
```

### Plot: Gepickte Menge (Nachfrage)
```{r}
picks %>% 
  ggplot() +
  geom_line(aes(x=EinAusDat,y=picks, color=ArtikelNr)) +
  ylab("Gepickte Menge")+
  facet_wrap(~`Artikel-Bezeichnung`, scales="free") +
  # Text linksbündig
  theme(strip.text.x = element_text(hjust=0.0)) +
  ggtitle("") +
  theme(legend.position = "none")
```

### Plot: Gelieferte Menge/Losgröße (Lieferungen)
```{r}
picks %>% 
  ggplot() +
  geom_line(aes(x = EinAusDat, y = lot_size, color = `Artikel-Bezeichnung`))+
  ylab("Gelieferte Menge")+
  xlab('Datum')+
  facet_wrap(~`Artikel-Bezeichnung`, scales="free") +
  # Text linksbündig
  theme(strip.text.x = element_text(hjust=0.0)) +
  ggtitle("") +
  theme(legend.position = "none")
```

### Picks vs. Losgröße nach Artikel
```{r}
picks %>% filter(lot_size != 0) %>% group_by(`Artikel-Bezeichnung`) %>% mutate(med_lot = median(lot_size)) %>% 
  ggplot(aes(x=lot_size)) +
  geom_histogram()+
  geom_vline(aes(xintercept=med_lot), color="blue", linetype="dashed", size=0.75)+
  facet_wrap(~`Artikel-Bezeichnung`, scales="free") +
  # Text linksbündig
  theme(strip.text.x = element_text(hjust=0.0)) +
  ggtitle("Verteilung der Bestell-Losgrößen nach Artikel")+
  labs(x="Losgröße", y="Anzahl Bestellungen")

# Bifacial Glas separat plotten
picks %>% filter(lot_size != 0, `Artikel-Bezeichnung`=="DAS N-TOPcon Bifacial Glas-Glas (2+2mm) Black 415 WP") %>% group_by(`Artikel-Bezeichnung`) %>% mutate(med_lot = median(lot_size)) %>% 
  ggplot(aes(x=lot_size)) +
  geom_histogram()+
  geom_vline(aes(xintercept=med_lot), color="blue", linetype="dashed", size=0.75)+
  # Text linksbündig
  theme(strip.text.x = element_text(hjust=0.0)) +
  labs(x="", y="")+
  xlim(936-10, 936+10)
```

```{r}
# Pick-Losgrößen
picks %>% filter(picks != 0) %>%
  ggplot(aes(x=picks, group=klasse, fill=klasse)) +
  geom_histogram() +
  facet_wrap(~`Artikel-Bezeichnung`, scales="free") +
  # Text linksbündig
  theme(strip.text.x = element_text(hjust=0.0)) +
  ggtitle("Verteilung der Pick-Losgrößen nach Artikel")
```

## Histogram und Median der Bestelllosgröße für jedes Produkt

```{r}
picks %>% filter(ArtikelNr == 29523,lot_size !=0 ) %>% 
  ggplot(aes(x=lot_size)) +
  geom_histogram(binwidth=.1, colour="black", fill="white")+
  geom_vline(aes(xintercept=median(lot_size, na.rm=T)), color="red", linetype="dashed", size=1)
```

```{r}
picks %>% filter(ArtikelNr == 26535,lot_size !=0  ) %>%
  ggplot(aes(x=lot_size)) + 
  geom_histogram(binwidth=1,colour="black", fill="white") +
  geom_vline(aes(xintercept=median(lot_size, na.rm=T)), color="red", linetype="dashed", size=1)
```
```{r}
picks %>% filter(ArtikelNr == 21866,lot_size !=0  ) %>%
  ggplot(aes(x=lot_size)) + 
  geom_histogram(binwidth=1,colour="black", fill="white") +
  geom_vline(aes(xintercept=median(lot_size, na.rm=T)), color="red", linetype="dashed", size=1)
```
```{r}
picks %>% filter(ArtikelNr == 2628,lot_size !=0  ) %>%
  ggplot(aes(x=lot_size)) + 
  geom_histogram(binwidth=1,colour="black", fill="white") +
  geom_vline(aes(xintercept=median(lot_size, na.rm=T)), color="red", linetype="dashed", size=1)
```
```{r}
picks %>% filter(ArtikelNr == 26385,lot_size !=0  ) %>%
  ggplot(aes(x=lot_size)) + 
  geom_histogram(binwidth=1,colour="black", fill="white") +
  geom_vline(aes(xintercept=median(lot_size, na.rm=T)), color="red", linetype="dashed", size=1)
```
```{r}
picks %>% filter(ArtikelNr == 6203,lot_size !=0  ) %>%
  ggplot(aes(x=lot_size)) + 
  geom_histogram(binwidth=1,colour="black", fill="white") +
  geom_vline(aes(xintercept=median(lot_size, na.rm=T)), color="red", linetype="dashed", size=1)
```

### Tabelle des Medians der Bestell-Losgrößen nach Artikel
```{r}
picks %>% filter(lot_size !=0) %>%  group_by(`Artikel-Bezeichnung`) %>% summarise(median_lot = mean(lot_size))
```
### Verteilung der Picks nach Artikel
```{r}
picks %>% filter(picks !=0) %>% group_by(`Artikel-Bezeichnung`)%>% mutate(med_pick = median(picks)) %>% 
  ggplot(aes(x=picks))+ 
  geom_histogram(colour="black", fill="white")+
  geom_vline(aes(xintercept=med_pick), color="red", linetype="dashed", size=0.75)+
  facet_wrap(~`Artikel-Bezeichnung`, scales="free") +
  # Text linksbündig
  theme(strip.text.x = element_text(hjust=0.0)) +
  ggtitle("Verteilung der Picks nach Artikel")
  
```
### Median und Durchschnitt der Picks nach Artikel
```{r}
picks %>% filter(picks !=0) %>%  group_by(`Artikel-Bezeichnung`) %>% summarise(median_pick = median(picks), avg_picks= mean(picks))
```

```{r}
# Berechnen der kumulierten Nachfrage nach Wochen
weekly_picks <- picks %>%
  group_by(ArtikelNr, week = floor_date(EinAusDat, 'week')) %>%
  summarise(picks_per_week= sum(picks)) 
```

```{r}
# Berechnen der Durchschnittsnachfrage nach Wochen
weekly_avg_picks <- picks %>%
  group_by(ArtikelNr, week = floor_date(EinAusDat, 'week')) %>%
  summarise(avgpicks_per_week= mean(picks)) 
```


```{r}
# Berechnen der Bestell-Losgröße nach Wochen
weekly_meanpick <- weekly_picks %>%  group_by(ArtikelNr) %>%
  mutate(mean_pick = mean(picks_per_week))
```

```{r}
weekly_picks %>% 
  ggplot() +
  geom_line(aes(x=week ,y=picks_per_week, group= ArtikelNr, col= ArtikelNr))
```
```{r}
# Berechnen der Durchschnittlichen Bestell-Losgröße nach Wochen
weekly_avg_picks %>% 
  ggplot() +
  geom_line(aes(x=week ,y=avgpicks_per_week, group= ArtikelNr, col= ArtikelNr))
```




## Nachfrage
### Tägliche Nachfrage
```{r}
# Nachfrage (Lagerausgänge = negative Werte) pro Tag
materials_b_tägl_menge <- materials_b %>%
  filter(Menge < 0) %>%
  group_by(EinAusDat, `Artikel-Bezeichnung`, klasse) %>%
  summarize(tägl_menge=-sum(Menge))

# Nachfrageverlauf über die Zeit
materials_b_tägl_menge %>% ggplot() +
  geom_point(aes(x=EinAusDat, y=tägl_menge, group=klasse, color=klasse), size=0.75)+
  facet_wrap(~`Artikel-Bezeichnung`, scales="free_y", nrow=3)+
    theme(strip.text.x = element_text(hjust=0.0))+
  scale_color_manual(values=c("Handel" = "#2A2AD5",
                             "Projekt" = "#FF8000",
                             "Einkauf" = "#00FFFF", 
                             "Anderes" = "grey"))+
  labs(x="", y="Tägliche Nachfrage", color="Geschäftsbereich")

# 90% und 95% Perzentile
materials_b_tägl_menge %>%
  group_by(`Artikel-Bezeichnung`) %>%
  summarize(percentile_90 = quantile(tägl_menge, probs=0.9),
            percentile_95 = quantile(tägl_menge, probs=0.95))

# Histogramm
ggplot(materials_b_tägl_menge, aes(x=tägl_menge, group=klasse, fill=klasse)) +
    geom_histogram() +
    facet_wrap(~`Artikel-Bezeichnung`, scales = 'free', nrow=3) +
    # Text linksbündig
    theme(strip.text.x = element_text(hjust=0.0)) +
    ggtitle("Verteilung der täglichen Ausgangsmengen (Nachfrage)")+
  scale_fill_manual(values=c("Handel" = "#2A2AD5",
                             "Projekt" = "#FF8000",
                             "Einkauf" = "#00FFFF", 
                             "Anderes" = "grey"))+
  labs(y="", x="Tägliche Nachfrage", fill="Geschäftsbereich")+
  theme(legend.position="bottom")
```

### Plots: Monatliche Nachfrage
```{r}
# Nachfrage nach Geschäftsbereich
materials %>% filter(Menge <0, EinAusDat<="2023-06-12") %>% group_by(mon=as.yearmon(EinAusDat), klasse) %>% summarize(s=sum(-Menge)) %>% ggplot(aes(x=mon, y=s))+
  geom_col(aes(group=klasse, fill=klasse))+
  scale_fill_manual(values=c("Handel" = "#2A2AD5",
                             "Projekt" = "#FF8000",
                             "Einkauf" = "#00FFFF", 
                             "Anderes" = "grey"))+
  labs(y="Monatliche Nachfrage", x="", fill="Geschäftsbereich")+
  theme(legend.position="bottom")+
  geom_smooth(data=materials %>% filter(Menge <0, EinAusDat<="2023-06-12") %>% group_by(mon=as.yearmon(EinAusDat)) %>% summarize(s=sum(-Menge)), aes(x=mon, y=s), method=lm, se=FALSE, color="black")+
  ylim(0, NA)
```


```{r}
# Monatliche Nachfrage nach Artikel
materials_b_monatl_menge <- materials_b %>%
  filter(Menge < 0) %>%
  group_by(month=as.yearmon(EinAusDat), `Artikel-Bezeichnung`) %>%
  summarize(monatl_menge=-sum(Menge))

ggplot(data=materials_b_monatl_menge, aes(x=month, y=monatl_menge)) +
  geom_line() +
  facet_wrap(~`Artikel-Bezeichnung`, scales = 'free_y') +
  # Text linksbündig
  theme(strip.text.x = element_text(hjust=0.0)) +
  # Rotate Axis Ticks
  #theme(axis.text.x = element_text(angle = 90)) +
  ylab("Monatliche Nachfrage") +
  geom_smooth(method=lm)
```
### Plot: Nachfrage nach Geschäftsbereich
```{r}
materials %>% filter(Menge <0) %>% group_by(klasse) %>% summarize(Nachfrage=sum(-Menge)/10**6) %>%
  ggplot(aes(x=reorder(klasse, -Nachfrage), y=Nachfrage, fill=klasse))+
  geom_col()+
  scale_fill_manual(values=c("Handel" = "#2A2AD5",
                             "Projekt" = "#FF8000",
                             "Einkauf" = "#00FFFF", 
                             "Anderes" = "grey"))+
  labs(x="", y="Nachfrage [mio. Stück]") +
  theme(legend.position = "none")
```

## Wiederbeschaffungszeit (WBZ)
```{r}
WBZ_Daten <- materials_b %>% filter(EinAutDatTyp == "geliefertAm")
WBZ_Daten$WBZ <- WBZ_Daten$EinAusDat - WBZ_Daten$BstDat

# Nur positive WBZ (negative basieren auf fehlerhaften Transaktionen)
WBZ_Daten <- WBZ_Daten %>% filter(WBZ > 0)
WBZ_Daten[,c("ArtikelNr", "Artikel-Bezeichnung", "BstDat", "EinAusDat", "WBZ")]

# Histogramm
WBZ_Daten %>%
  ggplot(aes(x=WBZ)) +
  geom_histogram() +
  facet_wrap(~`Artikel-Bezeichnung`, scales = "free", nrow=3) +
  labs(x = "Wiederbeschaffungszeit", y = "Anzahl") +
  geom_vline(data=WBZ_Daten %>% group_by(`Artikel-Bezeichnung`) %>% summarize(hist_mean=mean(WBZ)), aes(xintercept=hist_mean), color="blue", linetype="dashed", size=0.5)+
    # Text linksbündig
    theme(strip.text.x = element_text(hjust=0.0))

# Verteilungmasse
WBZ_Daten %>% 
  group_by(ArtikelNr, `Artikel-Bezeichnung`) %>%
  summarize(mean = mean(WBZ),
            median = median(WBZ),
            sd = sd(WBZ))

# Im Zeitverlauf - täglich
WBZ_Daten %>%
  ggplot(aes(x=EinAusDat, y=WBZ))+
  geom_point(size=0.75)+
  facet_wrap(~`Artikel-Bezeichnung`, scales = "free_y", nrow=3)+
    # Text linksbündig
    theme(strip.text.x = element_text(hjust=0.0))+
  labs(y="Wiederbeschaffungszeit")
```

# Phase 4: Analyse & Modellierung
## Nachfrage und WBZ vorbereiten
```{r}
# Zukunftswerte filtern
materials_b <- materials_b %>% filter(EinAusDat <= "2023-06-12")

# Tägliche Nachfrage
tägl_nachfrage <- materials_b %>%
  filter(Menge < 0) %>% # nur Nachfrage-Transaktionen
  group_by(EinAusDat, `Artikel-Bezeichnung`) %>% # Täglich und nach Artikel
  summarize(tägl_menge=-sum(Menge)) %>%
  group_by(`Artikel-Bezeichnung`) %>%  # für Artikel über gesamte Zeit aggregieren
  summarize(Konservativ=quantile(tägl_menge, 0.9),
            Ausgewogen=quantile(tägl_menge, 0.5),
            Risikofreudig=quantile(tägl_menge, 0.5))
tägl_nachfrage

# Wiederbeschaffungszeit
wbz <- materials_b %>% filter(EinAutDatTyp == "geliefertAm") %>%
  mutate(WBZ=EinAusDat - BstDat) %>%
  filter(WBZ > 0) %>%  # Nur positive WBZ (negative basieren auf fehlerhaften Transaktionen)
  group_by(`Artikel-Bezeichnung`) %>%
  summarize(Konservativ=quantile(WBZ, 0.9),
            Ausgewogen=quantile(WBZ, 0.5),
            Risikofreudig=quantile(WBZ, 0.0))
wbz
```

## Bestandverlauf mit neuer Bestellpolitik
```{r}
alle_artikel <- data.frame()

# Loop über alle Bestellpolitiken
for (politik in c("Konservativ", "Ausgewogen", "Risikofreudig")) {
  cat("\n\n\n________________________________\nVerfolgte Bestellpolitik:", politik)
  
# Loop über alle Artikel/Materialien
for (mat in materials_group_b) {

  # Start-Parameter
  artikel <- mat
  artikelNr <- first(materials_b[materials_b$`Artikel-Bezeichnung` == artikel, "ArtikelNr"])
  
  # Quantile heraussuchen
  spalte <- ifelse(politik=="Konservativ", "Konservativ", ifelse(politik=="Ausgewogen", "Ausgewogen", "Risikofreudig"))
  wbz_quantil <- as.numeric(wbz[wbz$`Artikel-Bezeichnung`==mat, spalte])
  nachfrage_quantil <- as.numeric(tägl_nachfrage[tägl_nachfrage$`Artikel-Bezeichnung`==mat, spalte])
  
  # Losgröße berechnen nach Formel
  losgröße <- nachfrage_quantil * wbz_quantil
  startbestand <- losgröße
  
  # Reale Nachfragewerte vorbereiten zum Iterieren
  nachfrage <- materials_b %>%
    filter(Menge < 0, `Artikel-Bezeichnung`==artikel, !is.na(EinAusDat)) %>%
    mutate(cum_sum=cumsum(Menge))
  
  # Variablen für Loop
  bestand <- startbestand
  bestelldaten <- c()
  bestellmengen <- c()
  
  # Bestelldaten berechnen
  for (i in 1:nrow(nachfrage)) {
    row <- nth(nachfrage, i)
    
    bestand <- bestand + as.numeric(row$Menge)
    
    if (bestand <= losgröße) {
      # Bestellung auslösen
      bestelldaten <- append(bestelldaten, row$EinAusDat)
      
      # Bestellmenge = Losgröße plus was zusätzlich fehlt
      bestellmenge <- losgröße + (losgröße-bestand)
      bestellmengen <- append(bestellmengen, bestellmenge)
      bestand <- bestand + bestellmenge
    }
  }
  
  # Erste Zeile - Anfangswert
  anfang <- data.frame(ArtikelNr=artikelNr,
                       `Artikel-Bezeichnung`=artikel,
                       EinAusDat=min(nachfrage$EinAusDat, na.rm=TRUE),
                       EinAusDatTyp="geliefertAm",
                       BstDat=min(nachfrage$EinAusDat, na.rm=TRUE) - wbz_quantil,
                       Menge=startbestand,
                       Bestand=NA,
                       PjNr=NA,
                       PjInfo=NA,
                       ORGAKzl="Anfangsbestand",
                       klasse="Einkauf",
                       cum_sum=NA)
  
  # DataFrame mit allen Bestellungen
  mengen <- data.frame(ArtikelNr=artikelNr,
                       `Artikel-Bezeichnung`=artikel,
                       EinAusDat=bestelldaten + wbz_quantil,
                       EinAusDatTyp="geliefertAm",
                       BstDat=bestelldaten,
                       Menge=bestellmengen,
                       Bestand=NA,
                       PjNr=NA,
                       PjInfo=NA,
                       ORGAKzl="Neuer Einkauf",
                       klasse="Einkauf",
                       cum_sum=NA)
  
  colnames(anfang) <- colnames(nachfrage)
  colnames(mengen) <- colnames(nachfrage)
  
  # DataFrame zusammenführen, cum_sum (= Bestand) neu berechnen
  ges <- rbind(anfang, mengen, nachfrage) %>%
    arrange(EinAusDat) %>%
    mutate(cum_sum = cumsum(Menge), Bestellpolitik=politik)
  # DataFrame mit Gesamt-DF zusammenführen
  alle_artikel <- rbind(alle_artikel, ges)
  
  # Statistiken
  cat("\n\n", artikel)
  cat("\n----------------------------------")
  cat("\nLosgröße (= Meldebestand) = ", losgröße)
  cat("\nAngenommene Wiederbeschaffungszeit = ", wbz_quantil)
  cat("\nAnzahl Bestellungen = ", nrow(mengen))
  cat("\nBestellungen MBG = ", nrow(materials_b %>% filter(Menge > 0, `Artikel-Bezeichnung`==artikel)))
  cat("\nAnzahl Stock-outs = ", nrow(ges %>% filter(cum_sum < 0 & lag(cum_sum) >=0)))
  cat("\nAnzahl Stock-outs MBG = ", nrow(materials_b %>% filter(`Artikel-Bezeichnung`==artikel, Bestand < 0 & lag(Bestand) >=0)))
  
  # Individuelle Ergebnisse plotten
  #ggplot(data=vergleich) + geom_line(aes(x=EinAusDat,y=cum_sum, group=Bestellpolitik, color=Bestellpolitik))+ggtitle(artikel)
  
}
}

# DataFrame mit MBG Performance zusammenführen
alle_artikel <- rbind(alle_artikel, materials_b %>% mutate(cum_sum=Bestand, Bestellpolitik="MBG") # Bestand statt cumsum der Menge, um richtige Anfangswerte zu haben
                     #mutate(cum_sum=cumsum(Menge), Bestellpolitik="MBG")
                   )
```

## Plots der Bestandspolitiken
```{r}
# Gesamtplot über alle Materialien
ggplot(data=alle_artikel) +
  geom_line(aes(x=EinAusDat,y=cum_sum, group=Bestellpolitik, color=Bestellpolitik))+
  facet_wrap(~`Artikel-Bezeichnung`, nrow=3, scale="free_y")+
  ylab("Bestand")+
  scale_color_manual(values=c("MBG"="#A4182D", "Konservativ"="#377eb8", "Ausgewogen"="#4daf4a", "Risikofreudig"="#ff7f00"))+
  # Text linksbündig
  theme(strip.text.x = element_text(hjust=0.0))
```

```{r}
# Einzelplots
mat <- "Rahmenloser Bildhalter Antireflexglas 29,7 x 42"

ggplot(data=alle_artikel %>% filter(`Artikel-Bezeichnung`==mat)) +
  geom_line(aes(x=EinAusDat,y=cum_sum, group=Bestellpolitik, color=Bestellpolitik), show.legend=FALSE)+
  labs(y="Bestand", x="")+
  ggtitle(mat)+
  
  # Zusätze für schönere Legende
  geom_point(aes(x=EinAusDat, y=cum_sum, fill=Bestellpolitik), size=-1)+
  theme(legend.position = "bottom")+
  guides(fill = guide_legend(keywidth = unit(1, "cm"),
                               keyheight = unit(1, "cm"),
                               override.aes = list(shape = 22,
                                                   size = 10)))+
  scale_color_manual(values=c("MBG"="#A4182D", "Konservativ"="#377eb8", "Ausgewogen"="#4daf4a", "Risikofreudig"="#ff7f00"))+
  scale_fill_manual(values=c("MBG"="#A4182D", "Konservativ"="#377eb8", "Ausgewogen"="#4daf4a", "Risikofreudig"="#ff7f00"))
```

# Phase 5: Ergebnisbewertung
## Anzahl Bestellungen
```{r}
# Anmerkung: Von den Bestellungen der neuen Bestellpolitiken muss 1 abgezogen werden (Startwert)
alle_artikel %>% filter(Menge > 0) %>%
  group_by(`Artikel-Bezeichnung`, Bestellpolitik) %>% count() %>%
  pivot_wider(names_from=Bestellpolitik, values_from=n)
```

## Durchschnittlicher Lagerbestand
```{r}
alle_artikel %>% group_by(`Artikel-Bezeichnung`, Bestellpolitik) %>% summarize(mean_bestand=mean(cum_sum)) %>% pivot_wider(names_from=Bestellpolitik, values_from=mean_bestand)
```

## Stock-outs
```{r}
alle_artikel %>% filter(cum_sum < 0 & lag(cum_sum) >=0) %>%
  group_by(`Artikel-Bezeichnung`, Bestellpolitik) %>% count() %>%
  pivot_wider(names_from=Bestellpolitik, values_from=n)
```

## Business Impact: Kapitalbindung
```{r}
kosten <- data.frame(`Artikel-Bezeichnung`=materials_group_b,
                     Stückpreis=c(170, 36.58, 2.85*280/100, 9.39, 11.77, 28.1/500))
colnames(kosten) <- c("Artikel-Bezeichnung", "Stückpreis")

alle_artikel %>% group_by(`Artikel-Bezeichnung`, Bestellpolitik) %>% summarize(gesamtbestand=sum(cum_sum)) %>% pivot_wider(names_from=Bestellpolitik, values_from=gesamtbestand) %>%
  mutate(Unterschied=MBG - Risikofreudig) %>%
  inner_join(kosten, by="Artikel-Bezeichnung") %>%
  mutate(Einsparungen=Unterschied*Stückpreis)
```

# Anhang
## Helper-Grafiken
```{r}
# Nachher entfernen
perzentil <- -3
ggplot(data.frame(x=c(-3,3)), aes(x)) + 
  stat_function(fun = dnorm,
                args = list(mean = 0, sd = 1), 
                geom = "area", 
                fill = "#C00000", n = 1001, xlim=c(-3, perzentil)) +
    stat_function(fun = dnorm,
                args = list(mean = 0, sd = 1), 
                geom = "area", 
                fill = "grey", n = 1001, xlim = c(perzentil, 3)) +
  labs(x="", y="") +
  scale_y_continuous(breaks = NULL)+
  scale_x_continuous(breaks=NULL)+geom_vline(aes(xintercept=-3), color="#C00000", size=2)
```

## Zeitreihenanalysen
### Zeitreihenanalyse Nachfrage
#### Baseline-Modell (Durchschnitt)
```{r}
materials_b <- materials_b %>% group_by(ArtikelNr) %>% mutate(Baseline = mean(Menge))

evaluation = data.frame(Model = "Baseline",
                        MFE = numeric(1),
                        MAE = numeric(1),
                        MSE = numeric(1),
                        sMAPE = numeric(1))
# MFE berechnen
evaluation[evaluation$Model == "Baseline",] $MFE = mean(materials_b$Menge - materials_b$Baseline)

evaluation[evaluation$Model == "Baseline",] $MAE = mean(abs(materials_b$Menge - materials_b$Baseline))


evaluation[evaluation$Model == "Baseline",] $MSE = mean((materials_b$Menge - materials_b$Baseline)^2)


evaluation[evaluation$Model == "Baseline",] $sMAPE = smape(materials_b$Menge, materials_b$Baseline)

evaluation
```

#### Gesamtmodell
```{r}
# Monatliche Durchschnittsnachfrage nehmen
materials_B_aus <- materials_b %>%
  filter(Menge < 0) %>%
  group_by(ArtikelNr, `Artikel-Bezeichnung`, month=as.yearmon(EinAusDat)) %>%
  summarize(menge_pro_monat= sum(-Menge))

# Gesamt-DataFrame
zeitreihen_alle_materialien <- data.frame()

for (mat in unique(materials_b$`Artikel-Bezeichnung`)) {
  cat("\n\n-------------------------------------\nCurrent material: ", mat)
  mat_subset <- materials_B_aus %>% filter(`Artikel-Bezeichnung` == mat)
  ts <- ts(mat_subset$menge_pro_monat, frequency = 12)
  #plot.ts(ts_3d_Scheiben)
  
  # Create model
  model <- ets(ts, model="ZZZ")
  print(model)
  
  fcast <- forecast(model, 12)
  
  # DataFrame für Originaldaten
  df_orig = data.frame(
    period = seq(1, length(fcast$x), 1), 
    bestand = as.numeric(fcast$x), 
    group = rep("Original", length(fcast$x)))
  
  # DataFrame für Forecast erstellen (sowohl Vorhersage für Zeitreihenwerte als auch ein Jahr in die Zukunft)
  df_fcast = data.frame(
    period = seq(1, length(fcast$fitted)+length(fcast$mean), 1), 
    bestand = c(as.numeric(fcast$fitted), as.numeric(fcast$mean)), 
    group = rep("Modell", length(fcast$fitted)+length(fcast$mean)))
  
  # In ein DataFrame zusammenführen
  df = rbind(df_orig, df_fcast)
  
  # In Gesamt-DataFrame hinzufügen
  zeitreihen_alle_materialien <- rbind(zeitreihen_alle_materialien, df %>% mutate(Artikel=mat))
  
  # Plot (print() hinzufügen, wenn jeder Plot einzeln ausgegeben werden soll)
  ggplot(df, aes(x = period, y = bestand, colour = group)) +
    geom_line()+
    xlab("Periode") +
    ylab("Nachfrage") +
    ggtitle("Gesamtmodell (Projekt + Großhandel) für Artikel:", mat) +
    theme(legend.title = element_blank()
  )
} 

# Für alle Materialien plotten
ggplot(zeitreihen_alle_materialien, aes(x = period, y = bestand, colour = group)) +
    geom_line()+
    facet_wrap(~Artikel, nrow=3, scales="free_y")+
    xlab("Periode") +
    ylab("Nachfrage") +
    ggtitle("Gesamtmodell (Projekt + Großhandel)") +
    theme(legend.title = element_blank())

```



#### Projektbetrieb
```{r}
# Monatliche Durchschnittsnachfrage - neu gruppieren für richtige Werte
materials_B_aus <- materials_b %>%
  filter(Menge < 0) %>%
  ## CHANGE MADE HERE ##
  filter(klasse == "Projekt") %>%
  group_by(ArtikelNr, `Artikel-Bezeichnung`, month=as.yearmon(EinAusDat)) %>%
  summarize(menge_pro_monat= sum(-Menge))

# Gesamt-DataFrame
zeitreihen_alle_materialien <- data.frame()

# Projektbetrieb
for (mat in unique(materials_b$`Artikel-Bezeichnung`)) {
  cat("\n\n-------------------------------------\nCurrent material: ", mat)
  mat_subset <- materials_B_aus %>% filter(`Artikel-Bezeichnung` == mat)
  ts <- ts(mat_subset$menge_pro_monat, frequency = 12)
  
  # Create model
  model <- ets(ts, model="ZZZ")
  print(model)
  
  fcast <- forecast(model, 12)
  
  # DataFrame für Originaldaten
  df_orig = data.frame(
    period = seq(1, length(fcast$x), 1), 
    bestand = as.numeric(fcast$x), 
    group = rep("Original", length(fcast$x)))
  
  # DataFrame für Forecast erstellen (sowohl Vorhersage für Zeitreihenwerte als auch ein Jahr in die Zukunft)
  df_fcast = data.frame(
    period = seq(1, length(fcast$fitted)+length(fcast$mean), 1), 
    bestand = c(as.numeric(fcast$fitted), as.numeric(fcast$mean)), 
    group = rep("Modell", length(fcast$fitted)+length(fcast$mean)))
  
  # In ein großes DataFrame zusammenführen
  df = rbind(df_orig, df_fcast)
  
  # In Gesamt-DataFrame hinzufügen
  zeitreihen_alle_materialien <- rbind(zeitreihen_alle_materialien, df %>% mutate(Artikel=mat))
  
  # Plot
  ggplot(df, aes(x = period, y = bestand, colour = group)) +
    geom_line()+
    xlab("Periode") +
    ylab("Nachfrage") +
    ggtitle("Modell auf Projektdaten für Artikel:", mat) +
    theme(legend.title = element_blank())
} 

# Für alle Materialien plotten
ggplot(zeitreihen_alle_materialien, aes(x = period, y = bestand, colour = group)) +
    geom_line()+
    facet_wrap(~Artikel, nrow=3, scales="free_y")+
    xlab("Periode") +
    ylab("Nachfrage") +
    ggtitle("Modell für Projektbetrieb") +
    theme(legend.title = element_blank())
```

#### Großhandel
```{r}
# Monatliche Durchschnittsnachfrage - neu gruppieren für richtige Werte
materials_B_aus <- materials_b %>%
  filter(Menge < 0) %>%
  ## CHANGE MADE HERE ##
  filter(klasse == "Handel") %>%
  mutate(cum_sum_aus = -cumsum(Menge)) %>%
  group_by(ArtikelNr, `Artikel-Bezeichnung`, month=as.yearmon(EinAusDat)) %>%
  summarize(menge_pro_monat= sum(-Menge))

# Gesamt-DataFrame
zeitreihen_alle_materialien <- data.frame()

for (mat in unique(materials_b$`Artikel-Bezeichnung`)) {
  cat("\n\n-------------------------------------\nCurrent material: ", mat)
  mat_subset <- materials_B_aus %>% filter(`Artikel-Bezeichnung` == mat)
  if (nrow(mat_subset) == 0) {
    cat("\nNo data available for ", mat)
    next
  }
  
  ts <- ts(mat_subset$menge_pro_monat, frequency = 12)
  
  # Create model
  model <- ets(ts, model="ZZZ")
  print(model)
  
  fcast <- forecast(model, 12)
  
  # DataFrame für Originaldaten
  df_orig = data.frame(
    period = seq(1, length(fcast$x), 1), 
    bestand = as.numeric(fcast$x), 
    group = rep("Original", length(fcast$x)))
  
  # DataFrame für Forecast erstellen (sowohl Vorhersage für Zeitreihenwerte als auch ein Jahr in die Zukunft)
  df_fcast = data.frame(
    period = seq(1, length(fcast$fitted)+length(fcast$mean), 1), 
    bestand = c(as.numeric(fcast$fitted), as.numeric(fcast$mean)), 
    group = rep("Modell", length(fcast$fitted)+length(fcast$mean)))
  
  # In ein großes DataFrame zusammenführen
  df = rbind(df_orig, df_fcast)
  
  # In Gesamt-DataFrame hinzufügen
  zeitreihen_alle_materialien <- rbind(zeitreihen_alle_materialien, df %>% mutate(Artikel=mat))
  
  # Plot
  ggplot(df, aes(x = period, y = bestand, colour = group)) +
    geom_line()+
    xlab("Periode") +
    ylab("Nachfrage") +
    ggtitle("Modell auf Großhandelsdaten für Artikel:", mat) +
    theme(legend.title = element_blank())
} 

# Für alle Materialien plotten
ggplot(zeitreihen_alle_materialien, aes(x = period, y = bestand, colour = group)) +
    geom_line()+
    facet_wrap(~Artikel, nrow=3, scales="free_y")+
    xlab("Periode") +
    ylab("Nachfrage") +
    ggtitle("Modell für Großhandel") +
    theme(legend.title = element_blank())
```

### Zeitreihenanalyse Transaktionsmenge
```{r}
# Monatliche Durchschnittsnachfrage nehmen
transaktionen_monatlich <- materials %>% group_by(Monat=as.yearmon(EinAusDat)) %>% count() %>% filter(Monat < as.yearmon("2023-06"))

ts <- ts(transaktionen_monatlich$n, frequency = 12)
plot.ts(ts)

# Create model
model <- ets(ts, model="ZZZ")
print(model)

fcast <- forecast(model, 12)

# DataFrame für Originaldaten
df_orig = data.frame(
  period = seq(1, length(fcast$x), 1), 
  bestand = as.numeric(fcast$x), 
  group = rep("Original", length(fcast$x)))

# DataFrame für Forecast erstellen (sowohl Vorhersage für Zeitreihenwerte als auch ein Jahr in die Zukunft)
df_fcast = data.frame(
  period = seq(1, length(fcast$fitted)+length(fcast$mean), 1), 
  bestand = c(as.numeric(fcast$fitted), as.numeric(fcast$mean)), 
  group = rep("Modell", length(fcast$fitted)+length(fcast$mean)))

# In ein DataFrame zusammenführen
df = rbind(df_orig, df_fcast)

# Plot
ggplot(df, aes(x = period, y = bestand, colour = group)) +
  geom_line()+
  xlab("Periode") +
  ylab("Transaktionen") +
  theme(legend.title = element_blank())
```

## Reichweite
### Zeit bis zum ersten Pick
```{r}
# Reichweite bis 1. Pick = Zeit zwischen Bestelleingang (geliefertAm) und erster Transaktion (BereitDat, PjPhaseDat)
materials_b_1st_pick <- materials_b %>%
  # Nach Datum sortieren
  arrange(EinAusDat) %>%
  # Nach Material gruppieren
  group_by(ArtikelNr, `Artikel-Bezeichnung`) %>%
  mutate(bis_erster_pick = if_else(lead(EinAutDatTyp) %in% c("BereitDat", "PjPhaseDat"), as.numeric(difftime(lead(EinAusDat), EinAusDat, units="days")), NA)) %>%
  filter(EinAutDatTyp == "geliefertAm")
  # summarize(mean_bis_pick=mean(bis_erster_pick, na.rm=TRUE)) # NA remove for last entry

# Histogramm
ggplot(materials_b_1st_pick, aes(x=bis_erster_pick)) +
    geom_histogram(color="black", fill="white") +
    facet_wrap(~`Artikel-Bezeichnung`, scales = 'free') +
    # Text linksbündig
    theme(strip.text.x = element_text(hjust=0.0)) +
    ggtitle("Verteilung der Zeit von Bestelleingang bis zum ersten Pick [in Tagen]")

# Zeit zwischen Picks
# Mit WBZ gegenüberstellen
```

### Reichweite bis nächste Bestellung
```{r}
# = Zeit zwischen Bestelleingang und nächster Bestellung (BstDat -> wenn wir bestellen, nicht Eingang)
materials_b_n_bestellung <- materials_b %>%
  arrange(EinAusDat, ArtikelNr) %>%
  filter(EinAutDatTyp == "geliefertAm") %>%
  group_by(ArtikelNr, `Artikel-Bezeichnung`) %>%
  mutate(bis_n_bestl = as.numeric(difftime(lead(BstDat), EinAusDat, units="days")))
  # summarize(mean_bis_bestl=mean(bis_n_bestl, na.rm=TRUE)) # NA remove for last entry

# Histogramm
ggplot(materials_b_n_bestellung, aes(x=bis_n_bestl)) +
    geom_histogram(color="black", fill="white") +
    facet_wrap(~`Artikel-Bezeichnung`, scales = 'free') +
    # Text linksbündig
    theme(strip.text.x = element_text(hjust=0.0)) +
    ggtitle("Verteilung der Reichweite von Bestelleingang bis zur nächsten Bestellung [in Tagen]")
```