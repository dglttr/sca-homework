---
title: "Case Study - Gruppen 105 & 201"
subtitle: "Supply Chain Analytics SS23"
author: "Benjamin Grünwald, Cordelia Mena Hernandez, Daniel Glatter, Vinzenz Tom Andreas Schaak"
date: "2023-06-21"
output: pdf_document
header-includes:
  \usepackage{fvextra}
  \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines,commandchars=\\\{\}}
---

# Datenaufbereitung
```{r setup, include=FALSE}
# Laden von Packages
library(readxl)
library(tidyverse)
library(lubridate)
library(forecast)
library(zoo)
library(scales)
library(glue)
library(ggplot2)
library(Metrics)
library(knitr)
library(prophet)
library(purrr)
opts_chunk$set(tidy.opts=list(width.cutoff=60),tidy=TRUE, echo = TRUE, warning = FALSE, message = FALSE)
```

```{r}
# Daten einlesen
materials <- read_excel("data/MBG_Materialverlauf_20230612.xlsx")

# Datentypen konvertieren
materials$ArtikelNr <- as.factor(materials$ArtikelNr)
materials$`Artikel-Bezeichnung` <- as.factor(materials$`Artikel-Bezeichnung`)
materials$EinAutDatTyp <- as.factor(materials$EinAutDatTyp)
materials$PjNr <- as.factor(materials$PjNr)
materials$PjInfo <- as.factor(materials$PjInfo)
materials$ORGAKzl <- as.factor(materials$ORGAKzl)
materials$EinAusDat <- as.Date(materials$EinAusDat)
materials$BstDat <- as.Date(materials$BstDat)

# Klassifizierung der Transaktionen: Projekt, Handel, Einkauf - nach Keywords
projekt <- c('PV-Realisierung', 'PV: Realisierung', 'PV: Tankstelle', 'PV: ET', 'PV: EDEKA', 'PV: MBG', 'PV: MO', 'PV: SolarSun', 'PV-Anlage: Realisierung', 'PV: 15,39', 'PV: 175x', 'PV: 99,83', 'PV: EFH')
handel <- c('PV-Materialverkauf')
einkauf <- c('Einkauf', 'Groß- und Einzelhandel der MBG')

materials <- materials %>%
  mutate(klasse=if_else(grepl(paste(projekt, collapse='|'), PjInfo), "Projekt", if_else(grepl(paste(handel, collapse='|'), PjInfo), "Handel", if_else(grepl(paste(einkauf, collapse='|'), PjInfo), "Einkauf", "Anderes"))))

# Nur relevante Materialien für Gruppe B
materials_group_b <- c("DAS N-TOPcon Bifacial Glas-Glas (2+2mm) Black 415 WP",
                         "Rahmenloser Bildhalter Antireflexglas 29,7 x 42",
                         "Kabelbinder 280x4,5 mm schwarz",
                         "FPKU-EM-F PVC- Rohr grau EN50 L=3m",
                         "FINTECH Alu Steckrohr IESR 40 AL (3m)",
                         "3d-U-Scheiben     8,4   M 8         DIN 9021  A2")
materials_b <- materials %>%  filter(`Artikel-Bezeichnung` %in% materials_group_b)

materials_b
```

# Explorative Datenanalyse
## Deskriptive Statistiken
```{r}
# Anzahl Kunden
materials %>% filter(EinAutDatTyp != "geliefertAm") %>% select(ORGAKzl) %>% distinct() %>% count()
```

```{r}
# Anzahl Lieferanten
materials %>% filter(EinAutDatTyp == "geliefertAm") %>% select(ORGAKzl) %>% distinct() %>% count()
```

```{r}
# Anzahl Projekte
materials %>% select(PjInfo) %>% distinct() %>% count()
```
```{r}
# Anzahl Materialien
materials %>% select(`Artikel-Bezeichnung`) %>% distinct() %>% count()
```

## Plot: Verteilung Projektklassen
```{r}
transaktion_klassiert <- materials %>% group_by(klasse) %>% count()

ggplot(transaktion_klassiert, aes(x=reorder(klasse, -n, sum), y=n, fill=klasse)) +
  geom_col() +
  theme(legend.position = "none") +
  ylab("Anzahl Transaktionen") +
  xlab("")

```


## Plot: Bestand über Zeit
```{r}
materials_b %>% 
  ggplot() +
  geom_line(aes(x=EinAusDat,y=Bestand,group=ArtikelNr, color=ArtikelNr
                ))

ggplot(data=materials_b, aes(x=EinAusDat, y=Bestand)) +
    facet_wrap(~`Artikel-Bezeichnung`, nrow=3, scales="free_y") +
    geom_line() +
    xlab("Zeit") + 
    ylab("Bestand") +
    theme(legend.position = "none")

```

## Plot: Menge über Zeit
```{r}
materials_b %>% 
  ggplot() +
  geom_line(aes(x=EinAusDat,y=Menge,group=ArtikelNr, color=ArtikelNr
                ))
```

## Häufigkeit Materialien
```{r}
materials_b %>% group_by(`Artikel-Bezeichnung`) %>% count() %>% arrange(desc(n))
```

## Häufigkeit EinAusDatTyp
```{r}
materials_b %>% group_by(EinAutDatTyp) %>% count() %>% arrange(desc(n))
```

## Häufigkeiten EinAusDatTyp über alle Materialien
```{r}
materials %>% group_by(EinAutDatTyp) %>% count() %>% arrange(desc(n))
```

## Häufigkeit Projekte
```{r}
materials_b %>% group_by(PjInfo) %>% count() %>% arrange(desc(n))
```

## Plot: Mengen nach EinAusDatTyp
```{r}
materials_b %>% group_by(`Artikel-Bezeichnung`,EinAutDatTyp, month = lubridate::floor_date(EinAusDat, 'month')) %>%
  summarise(volume=sum(Menge)) %>%
  ggplot(aes(x=month,y=volume,group=EinAutDatTyp, color=EinAutDatTyp
                )) +
    geom_line() +
    facet_wrap(~`Artikel-Bezeichnung`, scales = 'free_y')
```

```{r}
# Einzelne Plots pro Artikel für Mengen nach EinAusDatTyp
library(sjPlot)
plots <- materials_b %>% group_by(`Artikel-Bezeichnung`) %>% nest %>% 
  mutate(plot = map2(
    data, `Artikel-Bezeichnung`, 
    ~ ggplot(data = .x, aes(x=EinAusDat,y=Menge,group=EinAutDatTyp, color=EinAutDatTyp)) +
      ggtitle(glue("{.y}")) +
      geom_line())) 

print(plots$plot)
```
## Plot: Korrigierter Bestand (cumsum)
```{r}
mat_verlauf <- materials_b %>%
  filter(EinAutDatTyp == "geliefertAm" | EinAutDatTyp == "BereitDat" | EinAutDatTyp == "PjPhaseDat") %>%
  group_by(`ArtikelNr`) %>%
  mutate(cum_sum = cumsum(Menge))
  

ggplot(data=mat_verlauf, aes(x=EinAusDat, y=cum_sum, fill=`ArtikelNr`)) +
    facet_wrap(~`Artikel-Bezeichnung`, nrow=3, scales="free_y") +
    geom_line() +
    xlab("Zeit") + 
    ylab("Materialmenge") +
    theme(legend.position = "none") +
    ggtitle("EinAutDatTyp = geliefertAm, BereitDat, PjPhaseDat")
```

## Differenzen der Menge zwischen Transaktionen
```{r}
materials_b <- materials_b %>%  group_by(ArtikelNr) %>%  mutate(Menge_diff = Menge - lag(Menge)) 
materials_b
```

```{r}
materials_b %>% 
  ggplot() +
  geom_line(aes(x=EinAusDat,y=Menge_diff,group=ArtikelNr, color=ArtikelNr
                ))
```
## Durchschnitte der Menge (Nachfrage und Lieferungen gemeinsam)
### Plot: Wochendurchschnitt der Menge
```{r}
# Berechnen des Durchschnitts nach Wochen

weekly_Menge <- materials_b %>%
  group_by(ArtikelNr, week = floor_date(EinAusDat, 'week')) %>%
  summarise(Menge_per_week= sum(Menge)) 

# Plot nach Wochen
weekly_Menge %>% 
  ggplot() +
  geom_line(aes(x=week,y=Menge_per_week, group=ArtikelNr, color=ArtikelNr
                ))
```

### Plot: Monatsdurchschnitt der Menge
```{r}
# Berechnen des Durchschnitts nach Monaten
monthly_mean <- weekly_Menge %>%  group_by(ArtikelNr, month=month(week)) %>%
  mutate(mean_Menge= mean(Menge_per_week))

monthly_mean %>% 
  ggplot() +
  geom_line(aes(x=month,y=mean_Menge, group=ArtikelNr, color=ArtikelNr
                ))
```

## Solarmodule
```{r}
solarmodul_artikel <- c("DAS N-TOPcon Bifacial Glas-Glas (2+2mm) Black 415 WP", "Panasonic VBHN300SJ46", "Q.PEAK DUO BLK-G9 340 Wp", "JAM54S30 - 410Wp/MR - Beistellung")
materials_solarmodule <- materials %>%
  filter(`Artikel-Bezeichnung` %in% solarmodul_artikel) %>%
  group_by(`ArtikelNr`) %>%
  mutate(cum_sum = cumsum(Menge))

ggplot(data=materials_solarmodule, aes(x=EinAusDat, y=cum_sum, fill=`ArtikelNr`)) +
    facet_wrap(~`Artikel-Bezeichnung`, nrow=2, scales="free_y") +
    geom_line() +
    xlab("Zeit") + 
    ylab("Materialmenge") +
    theme(legend.position = "none") +
    ggtitle("Verläufe Solarmodulbestand")
```

## Lieferanten
```{r}
lieferanten <- materials %>%
  filter(EinAutDatTyp == "geliefertAm") %>%
  group_by(Lieferant=ORGAKzl) %>%
  summarize(Anzahl_Bestellungen = n(),
            Anzahl_untersch_Materialien = n_distinct(`Artikel-Bezeichnung`),
            Lieferdauer = mean(EinAusDat - BstDat)) %>%
  arrange(desc(Anzahl_Bestellungen))

lieferanten
```


# Picks und Losgrößen
```{r}
picks <- materials_b %>% mutate(picks = if_else(Menge < 0, -Menge, 0), lot_size = if_else(Menge >= 0, abs(Menge), 0))
```

## Plot: Gepickte Menge (Nachfrage)
```{r}
picks %>% 
  ggplot() +
  geom_line(aes(x=EinAusDat,y=picks, group='Artikel-Bezeichnung', color=ArtikelNr, scale = 'free_y')) +
  ylab("Gepickte Menge")
```

## Plot: Gelieferte Menge/Losgröße (Lieferungen)
```{r}
picks %>% 
  ggplot() +
  geom_line(aes(x=EinAusDat,y=lot_size, group='Artikel-Bezeichnung', color=ArtikelNr, scale = 'free_y')) +
  ylab("Gelieferte Menge")
```

## Pickgröße vs. Bestell-Losgröße
```{r}
picks %>% filter(ArtikelNr == 29523, ) %>% 
  ggplot() +
  geom_line(aes(x=EinAusDat,y=picks, col= 'red')) +
  geom_line(aes(x=EinAusDat,y=lot_size, col='green'))
```

```{r}
picks %>% filter(ArtikelNr == 26535, ) %>% 
  ggplot() +
  geom_line(aes(x=EinAusDat,y=lot_size))
```

## Picks vs. Losgröße nach Artikel
```{r}
picks %>% filter(lot_size != 0) %>%
  ggplot(aes(x=lot_size, group=klasse, fill=klasse)) +
  geom_histogram()+
  #geom_vline(data=picks %>% group_by(`Artikel-Bezeichnung`) %>% summarize(mean_lot_size=mean(lot_size, na.rm=TRUE)), aes(xintercept=mean_lot_size), color="red", linetype="dashed", size=0.75) +
  facet_wrap(~`Artikel-Bezeichnung`, scales="free") +
  # Text linksbündig
  theme(strip.text.x = element_text(hjust=0.0)) +
  ggtitle("Verteilung der Bestell-Losgrößen nach Artikel")
```
```{r}
# Pick-Losgrößen
picks %>% filter(picks != 0) %>%
  ggplot(aes(x=picks, group=klasse, fill=klasse)) +
  geom_histogram() +
  facet_wrap(~`Artikel-Bezeichnung`, scales="free") +
  # Text linksbündig
  theme(strip.text.x = element_text(hjust=0.0)) +
  ggtitle("Verteilung der Pick-Losgrößen nach Artikel")
```



```{r}
picks %>% filter(ArtikelNr == 29523,lot_size !=0 ) %>% 
  ggplot(aes(x=lot_size)) +
  geom_histogram(binwidth=.1, colour="black", fill="white")+
  geom_vline(aes(xintercept=median(lot_size, na.rm=T)), color="red", linetype="dashed", size=1)
```

```{r}
picks %>% filter(ArtikelNr == 26535,lot_size !=0  ) %>%
  ggplot(aes(x=lot_size)) + 
  geom_histogram(binwidth=1,colour="black", fill="white") +
  geom_vline(aes(xintercept=median(lot_size, na.rm=T)), color="red", linetype="dashed", size=1)
```
```{r}
picks %>% filter(ArtikelNr == 21866,lot_size !=0  ) %>%
  ggplot(aes(x=lot_size)) + 
  geom_histogram(binwidth=1,colour="black", fill="white") +
  geom_vline(aes(xintercept=median(lot_size, na.rm=T)), color="red", linetype="dashed", size=1)
```
```{r}
picks %>% filter(ArtikelNr == 2628,lot_size !=0  ) %>%
  ggplot(aes(x=lot_size)) + 
  geom_histogram(binwidth=1,colour="black", fill="white") +
  geom_vline(aes(xintercept=median(lot_size, na.rm=T)), color="red", linetype="dashed", size=1)
```
```{r}
picks %>% filter(ArtikelNr == 26385,lot_size !=0  ) %>%
  ggplot(aes(x=lot_size)) + 
  geom_histogram(binwidth=1,colour="black", fill="white") +
  geom_vline(aes(xintercept=median(lot_size, na.rm=T)), color="red", linetype="dashed", size=1)
```
```{r}
picks %>% filter(ArtikelNr == 6203,lot_size !=0  ) %>%
  ggplot(aes(x=lot_size)) + 
  geom_histogram(binwidth=1,colour="black", fill="white") +
  geom_vline(aes(xintercept=median(lot_size, na.rm=T)), color="red", linetype="dashed", size=1)
```
```{r}
picks %>% filter(lot_size !=0) %>%  group_by(`Artikel-Bezeichnung`) %>% summarise(median_lot = median(lot_size))
```
```{r}
# Berechnen des Durchschnitts nach Wochen
weekly_picks <- picks %>%
  group_by(ArtikelNr, week = floor_date(EinAusDat, 'week')) %>%
  summarise(picks_per_week= sum(picks)) 
```

```{r}
weekly_avg_picks <- picks %>%
  group_by(ArtikelNr, week = floor_date(EinAusDat, 'week')) %>%
  summarise(avgpicks_per_week= mean(picks)) 
```


```{r}
weekly_meanpick <- weekly_picks %>%  group_by(ArtikelNr) %>%
  mutate(mean_pick = mean(picks_per_week))
```

```{r}
weekly_picks %>% 
  ggplot() +
  geom_line(aes(x=week ,y=picks_per_week, group= ArtikelNr, col= ArtikelNr))
```
```{r}
weekly_avg_picks %>% 
  ggplot() +
  geom_line(aes(x=week ,y=avgpicks_per_week, group= ArtikelNr, col= ArtikelNr))
```

# Zeitreihenanalyse
## Baseline-Modell (Durchschnitt)
```{r}
materials_b <- materials_b %>% group_by(ArtikelNr) %>% mutate(Baseline = mean(Menge))

evaluation = data.frame(Model = "Baseline",
                        MFE = numeric(1),
                        MAE = numeric(1),
                        MSE = numeric(1),
                        sMAPE = numeric(1))
# MFE berechnen
evaluation[evaluation$Model == "Baseline",] $MFE = mean(materials_b$Menge - materials_b$Baseline)

evaluation[evaluation$Model == "Baseline",] $MAE = mean(abs(materials_b$Menge - materials_b$Baseline))


evaluation[evaluation$Model == "Baseline",] $MSE = mean((materials_b$Menge - materials_b$Baseline)^2)


evaluation[evaluation$Model == "Baseline",] $sMAPE = smape(materials_b$Menge, materials_b$Baseline)

evaluation
```

## Gesamtmodell
```{r}
# Monatliche Durchschnittsnachfrage nehmen
materials_B_aus <- materials_b %>%
  filter(Menge < 0) %>%
  group_by(ArtikelNr, `Artikel-Bezeichnung`, month=as.yearmon(EinAusDat)) %>%
  summarize(menge_pro_monat= sum(-Menge))

# Gesamt-DataFrame
zeitreihen_alle_materialien <- data.frame()

for (mat in unique(materials_b$`Artikel-Bezeichnung`)) {
  cat("\n\n-------------------------------------\nCurrent material: ", mat)
  mat_subset <- materials_B_aus %>% filter(`Artikel-Bezeichnung` == mat)
  ts <- ts(mat_subset$menge_pro_monat, frequency = 12)
  #plot.ts(ts_3d_Scheiben)
  
  # Create model
  model <- ets(ts, model="ZZZ")
  print(model)
  
  fcast <- forecast(model, 12)
  
  # DataFrame für Originaldaten
  df_orig = data.frame(
    period = seq(1, length(fcast$x), 1), 
    bestand = as.numeric(fcast$x), 
    group = rep("Original", length(fcast$x)))
  
  # DataFrame für Forecast erstellen (sowohl Vorhersage für Zeitreihenwerte als auch ein Jahr in die Zukunft)
  df_fcast = data.frame(
    period = seq(1, length(fcast$fitted)+length(fcast$mean), 1), 
    bestand = c(as.numeric(fcast$fitted), as.numeric(fcast$mean)), 
    group = rep("Modell", length(fcast$fitted)+length(fcast$mean)))
  
  # In ein DataFrame zusammenführen
  df = rbind(df_orig, df_fcast)
  
  # In Gesamt-DataFrame hinzufügen
  zeitreihen_alle_materialien <- rbind(zeitreihen_alle_materialien, df %>% mutate(Artikel=mat))
  
  # Plot (print() hinzufügen, wenn jeder Plot einzeln ausgegeben werden soll)
  ggplot(df, aes(x = period, y = bestand, colour = group)) +
    geom_line()+
    xlab("Periode") +
    ylab("Nachfrage") +
    ggtitle("Gesamtmodell (Projekt + Großhandel) für Artikel:", mat) +
    theme(legend.title = element_blank()
  )
} 

# Für alle Materialien plotten
ggplot(zeitreihen_alle_materialien, aes(x = period, y = bestand, colour = group)) +
    geom_line()+
    facet_wrap(~Artikel, nrow=3, scales="free_y")+
    xlab("Periode") +
    ylab("Nachfrage") +
    ggtitle("Gesamtmodell (Projekt + Großhandel)") +
    theme(legend.title = element_blank())

```



## Projektbetrieb
```{r}
# Monatliche Durchschnittsnachfrage - neu gruppieren für richtige Werte
materials_B_aus <- materials_b %>%
  filter(Menge < 0) %>%
  ## CHANGE MADE HERE ##
  filter(klasse == "Projekt") %>%
  group_by(ArtikelNr, `Artikel-Bezeichnung`, month=as.yearmon(EinAusDat)) %>%
  summarize(menge_pro_monat= sum(-Menge))

# Gesamt-DataFrame
zeitreihen_alle_materialien <- data.frame()

# Projektbetrieb
for (mat in unique(materials_b$`Artikel-Bezeichnung`)) {
  cat("\n\n-------------------------------------\nCurrent material: ", mat)
  mat_subset <- materials_B_aus %>% filter(`Artikel-Bezeichnung` == mat)
  ts <- ts(mat_subset$menge_pro_monat, frequency = 12)
  
  # Create model
  model <- ets(ts, model="ZZZ")
  print(model)
  
  fcast <- forecast(model, 12)
  
  # DataFrame für Originaldaten
  df_orig = data.frame(
    period = seq(1, length(fcast$x), 1), 
    bestand = as.numeric(fcast$x), 
    group = rep("Original", length(fcast$x)))
  
  # DataFrame für Forecast erstellen (sowohl Vorhersage für Zeitreihenwerte als auch ein Jahr in die Zukunft)
  df_fcast = data.frame(
    period = seq(1, length(fcast$fitted)+length(fcast$mean), 1), 
    bestand = c(as.numeric(fcast$fitted), as.numeric(fcast$mean)), 
    group = rep("Modell", length(fcast$fitted)+length(fcast$mean)))
  
  # In ein großes DataFrame zusammenführen
  df = rbind(df_orig, df_fcast)
  
  # In Gesamt-DataFrame hinzufügen
  zeitreihen_alle_materialien <- rbind(zeitreihen_alle_materialien, df %>% mutate(Artikel=mat))
  
  # Plot
  ggplot(df, aes(x = period, y = bestand, colour = group)) +
    geom_line()+
    xlab("Periode") +
    ylab("Nachfrage") +
    ggtitle("Modell auf Projektdaten für Artikel:", mat) +
    theme(legend.title = element_blank())
} 

# Für alle Materialien plotten
ggplot(zeitreihen_alle_materialien, aes(x = period, y = bestand, colour = group)) +
    geom_line()+
    facet_wrap(~Artikel, nrow=3, scales="free_y")+
    xlab("Periode") +
    ylab("Nachfrage") +
    ggtitle("Modell für Projektbetrieb") +
    theme(legend.title = element_blank())
```

## Großhandel
```{r}
# Monatliche Durchschnittsnachfrage - neu gruppieren für richtige Werte
materials_B_aus <- materials_b %>%
  filter(Menge < 0) %>%
  ## CHANGE MADE HERE ##
  filter(klasse == "Handel") %>%
  mutate(cum_sum_aus = -cumsum(Menge)) %>%
  group_by(ArtikelNr, `Artikel-Bezeichnung`, month=as.yearmon(EinAusDat)) %>%
  summarize(menge_pro_monat= sum(-Menge))

# Gesamt-DataFrame
zeitreihen_alle_materialien <- data.frame()

for (mat in unique(materials_b$`Artikel-Bezeichnung`)) {
  cat("\n\n-------------------------------------\nCurrent material: ", mat)
  mat_subset <- materials_B_aus %>% filter(`Artikel-Bezeichnung` == mat)
  if (nrow(mat_subset) == 0) {
    cat("\nNo data available for ", mat)
    next
  }
  
  ts <- ts(mat_subset$menge_pro_monat, frequency = 12)
  
  # Create model
  model <- ets(ts, model="ZZZ")
  print(model)
  
  fcast <- forecast(model, 12)
  
  # DataFrame für Originaldaten
  df_orig = data.frame(
    period = seq(1, length(fcast$x), 1), 
    bestand = as.numeric(fcast$x), 
    group = rep("Original", length(fcast$x)))
  
  # DataFrame für Forecast erstellen (sowohl Vorhersage für Zeitreihenwerte als auch ein Jahr in die Zukunft)
  df_fcast = data.frame(
    period = seq(1, length(fcast$fitted)+length(fcast$mean), 1), 
    bestand = c(as.numeric(fcast$fitted), as.numeric(fcast$mean)), 
    group = rep("Modell", length(fcast$fitted)+length(fcast$mean)))
  
  # In ein großes DataFrame zusammenführen
  df = rbind(df_orig, df_fcast)
  
  # In Gesamt-DataFrame hinzufügen
  zeitreihen_alle_materialien <- rbind(zeitreihen_alle_materialien, df %>% mutate(Artikel=mat))
  
  # Plot
  ggplot(df, aes(x = period, y = bestand, colour = group)) +
    geom_line()+
    xlab("Periode") +
    ylab("Nachfrage") +
    ggtitle("Modell auf Großhandelsdaten für Artikel:", mat) +
    theme(legend.title = element_blank())
} 

# Für alle Materialien plotten
ggplot(zeitreihen_alle_materialien, aes(x = period, y = bestand, colour = group)) +
    geom_line()+
    facet_wrap(~Artikel, nrow=3, scales="free_y")+
    xlab("Periode") +
    ylab("Nachfrage") +
    ggtitle("Modell für Großhandel") +
    theme(legend.title = element_blank())
```

# Reichweite
## Zeit bis zum ersten Pick
```{r}
# Reichweite bis 1. Pick = Zeit zwischen Bestelleingang (geliefertAm) und erster Transaktion (BereitDat, PjPhaseDat)
materials_b_1st_pick <- materials_b %>%
  # Nach Datum sortieren
  arrange(EinAusDat) %>%
  # Nach Material gruppieren
  group_by(ArtikelNr, `Artikel-Bezeichnung`) %>%
  mutate(bis_erster_pick = if_else(lead(EinAutDatTyp) %in% c("BereitDat", "PjPhaseDat"), as.numeric(difftime(lead(EinAusDat), EinAusDat, units="days")), NA)) %>%
  filter(EinAutDatTyp == "geliefertAm")
  # summarize(mean_bis_pick=mean(bis_erster_pick, na.rm=TRUE)) # NA remove for last entry

# Histogramm
ggplot(materials_b_1st_pick, aes(x=bis_erster_pick)) +
    geom_histogram(color="black", fill="white") +
    facet_wrap(~`Artikel-Bezeichnung`, scales = 'free') +
    # Text linksbündig
    theme(strip.text.x = element_text(hjust=0.0)) +
    ggtitle("Verteilung der Zeit von Bestelleingang bis zum ersten Pick [in Tagen]")

# Zeit zwischen Picks
# Mit WBZ gegenüberstellen
```

## Reichweite bis nächste Bestellung
```{r}
# = Zeit zwischen Bestelleingang und nächster Bestellung (BstDat -> wenn wir bestellen, nicht Eingang)
materials_b_n_bestellung <- materials_b %>%
  arrange(EinAusDat, ArtikelNr) %>%
  filter(EinAutDatTyp == "geliefertAm") %>%
  group_by(ArtikelNr, `Artikel-Bezeichnung`) %>%
  mutate(bis_n_bestl = as.numeric(difftime(lead(BstDat), EinAusDat, units="days")))
  # summarize(mean_bis_bestl=mean(bis_n_bestl, na.rm=TRUE)) # NA remove for last entry

# Histogramm
ggplot(materials_b_n_bestellung, aes(x=bis_n_bestl)) +
    geom_histogram(color="black", fill="white") +
    facet_wrap(~`Artikel-Bezeichnung`, scales = 'free') +
    # Text linksbündig
    theme(strip.text.x = element_text(hjust=0.0)) +
    ggtitle("Verteilung der Reichweite von Bestelleingang bis zur nächsten Bestellung [in Tagen]")
```

# Nachfrage aggregiert nach Zeit
## Tägliche Nachfrage
```{r}
# Nachfrage (Lagerausgänge = negative Werte) pro Tag
materials_b_tägl_menge <- materials_b %>%
  filter(Menge < 0) %>%
  group_by(EinAusDat, `Artikel-Bezeichnung`) %>%
  summarize(tägl_menge=-sum(Menge))

# 90% und 95% Perzentile
materials_b_tägl_menge %>%
  group_by(`Artikel-Bezeichnung`) %>%
  summarize(percentile_90 = quantile(tägl_menge, probs=0.9),
            percentile_95 = quantile(tägl_menge, probs=0.95))

# Histogramm
ggplot(materials_b_tägl_menge, aes(x=tägl_menge)) +
    geom_histogram(color="black", fill="white") +
    facet_wrap(~`Artikel-Bezeichnung`, scales = 'free') +
    # Text linksbündig
    theme(strip.text.x = element_text(hjust=0.0)) +
    ggtitle("Verteilung der täglichen Ausgangsmengen (Nachfrage)")
```

## Monatliche Nachfrage
```{r}
# Menge aggregiert auf Monatsebene (lassen sich Trends erkennen?)
materials_b_monatl_menge <- materials_b %>%
  filter(Menge < 0) %>%
  group_by(month=as.yearmon(EinAusDat), `Artikel-Bezeichnung`) %>%
  summarize(monatl_menge=-sum(Menge))

ggplot(data=materials_b_monatl_menge, aes(x=month, y=monatl_menge)) +
  geom_line() +
  facet_wrap(~`Artikel-Bezeichnung`, scales = 'free_y') +
  # Text linksbündig
  theme(strip.text.x = element_text(hjust=0.0)) +
  # Rotate Axis Ticks
  #theme(axis.text.x = element_text(angle = 90)) +
  ylab("Monatliche Nachfrage") +
  geom_smooth(method=lm)
```

# Wiederbeschaffungszeit (WBZ)
```{r}
WBZ_Daten <- materials_b %>% filter(EinAutDatTyp == "geliefertAm")
WBZ_Daten$WBZ <- WBZ_Daten$EinAusDat - WBZ_Daten$BstDat

# Nur positive WBZ (negative basieren auf fehlerhaften Transaktionen)
WBZ_Daten <- WBZ_Daten %>% filter(WBZ > 0)
WBZ_Daten[,c("ArtikelNr", "Artikel-Bezeichnung", "BstDat", "EinAusDat", "WBZ")]

# Histogramm
WBZ_Daten %>%
  ggplot(aes(x=WBZ)) +
  geom_histogram(color = "black", fill="white") +
  facet_wrap(~`Artikel-Bezeichnung`, scales = "free") +
  labs(x = "WBZ", y = "Anzahl") +
  ggtitle("WBZ für Materialien Gruppe B") #+ 
  geom_vline(aes(xintercept=mean(WBZ)),
            color="blue", linetype="dashed", size=1)

# Verteilungmasse
WBZ_Daten %>% 
  group_by(ArtikelNr, `Artikel-Bezeichnung`) %>%
  summarize(mean = mean(WBZ),
            median = median(WBZ),
            sd = sd(WBZ))
```

# Bestandsanalyse

```{r}
mat_verlauf <- materials_b %>%
  filter(EinAutDatTyp == "geliefertAm" | EinAutDatTyp == "BereitDat" | EinAutDatTyp == "PjPhaseDat") %>%
  group_by(`ArtikelNr`) %>%
  mutate(cum_sum = cumsum(Menge))
  
mat_verlauf %>% 
    ggplot() +
      geom_line(aes(x=EinAusDat, y=cum_sum, fill=`ArtikelNr`)) +
      facet_wrap(~`Artikel-Bezeichnung`, nrow=3, scales="free") +
      xlab("Zeit") + 
      ylab("Materialmenge") +
      theme(legend.position = "none") +
      ggtitle("EinAutDatTyp = geliefertAm, BereitDat, PjPhaseDat")
```

```{r}
b <- mat_verlauf %>% group_by(`Artikel-Bezeichnung`) %>% mutate(bestand_lagged = Menge + Bestand) %>% mutate(bestand_aprox = lag(bestand_lagged)) 
b %>% summarise(falscher_lagerbestand_prozent = sum(bestand_lagged == bestand_aprox, na.rm = TRUE)/n())
b %>% ggplot(aes(x =EinAusDat)) +
  geom_line(aes(y=Bestand, color= "Bestand")) + geom_line(aes(y=bestand_aprox, color= "(Bestand + Menge) lagged")) +
  facet_wrap(~`Artikel-Bezeichnung`, nrow=3, scales="free") 
```
Wir können sehen dass an gewissen Punkten Lagerbestände falsch angegeben sind. Dies kann man dadurch belegen, dass bei Warenausgang oder Wareneingang, der Bestand in der nächste Transaktion dem vorherigen um die Veränderung entsprechen muss.


```{r}
ordered_quantity <- mat_verlauf %>% filter(EinAutDatTyp =='geliefertAm')
ordered_quantity %>%
  select(ArtikelNr, BstDat,) %>% left_join(mat_verlauf %>%
  select(EinAusDat,EinAutDatTyp, `Artikel-Bezeichnung`,Menge, Bestand, cum_sum) %>%
  filter(Menge<0) , join_by(ArtikelNr, closest(BstDat >= EinAusDat))) %>%
  drop_na() %>%
  ggplot()+ geom_histogram(aes(x=cum_sum, fill ="Cumsum")) + geom_histogram(aes(x= Bestand, fill ="Bestand")) + facet_wrap(~`Artikel-Bezeichnung`, nrow=3, scales="free")
```



```{r}
picks_between_order <- mat_verlauf %>% group_by(`Artikel-Bezeichnung`) %>% arrange(EinAusDat, .by_group = TRUE) %>%  fill(BstDat, .direction = "up",) %>%  filter(Menge<0) %>% group_by(`Artikel-Bezeichnung`, BstDat) %>% summarise(pick_quantity_between_orders = sum(abs(Menge)))

ggplot() + geom_line(aes(x= BstDat, y = pick_quantity_between_orders ,color="Picks"), data=picks_between_order)  + geom_point(aes(x= BstDat, y = pick_quantity_between_orders,color="Picks"), data =picks_between_order ,) +
  geom_line(aes(x= BstDat, y = Menge,color= "Bestellte_menge"), data=ordered_quantity) +
  geom_point(aes(x= BstDat, y = Menge, ,color= "Bestellte_menge"), data=ordered_quantity) +
  facet_wrap(~`Artikel-Bezeichnung`, nrow=3, scales="free") 


```
Der Plot stellt die Summe der Picks bevor einer Bestellung in Vergleich zur bestellten Menge dar. Man sieht das die Summe der Picks vor der Bestellung oft weit über der bestellten Menge liegen, das lässt auf größere Infeziente Lagerhaltung schliesen.


```{r}
picks_cum_sum_between_order <- mat_verlauf %>% select(ArtikelNr,`Artikel-Bezeichnung`,EinAusDat, BstDat,Menge, ) %>% group_by(`Artikel-Bezeichnung`) %>% arrange(EinAusDat, .by_group = TRUE) %>%  fill(BstDat, .direction = "up",) %>%  filter(Menge<0) %>% group_by(`Artikel-Bezeichnung`, BstDat) %>% mutate(pick_cum_sum_between_orders = cumsum(abs(Menge)))


nachf_in_WBZ <- ordered_quantity %>% select(ArtikelNr, BstDat, `Artikel-Bezeichnung`) %>% left_join(picks_cum_sum_between_order, join_by(ArtikelNr, closest(BstDat >= EinAusDat)))
  
ggplot(nachf_in_WBZ)+ geom_histogram(aes(x=pick_cum_sum_between_orders, fill ="Cumsum_picks")) + facet_wrap(~`Artikel-Bezeichnung.x`, nrow=3, scales="free")

nachf_in_WBZ %>% group_by(ArtikelNr) %>% summarize(quantile(pick_cum_sum_between_orders, 0.9, na.rm=TRUE))
```

```{r}
ordered_quantity
```


Der Plot zeigt die Verteilung der cumulierten Summe der Picks dar am Bestelltag der nächsten Bestellung. Dadurch dass der Wert nicht eindeutig ist, schiließen wir das der Logistiker kein eindeutigen Bestellmenge* hat

# Sicherheitsbestand
```{r}
# Parameter
perzentil_meldebestand <- 0.5
perzentil_nachfrage <- 0.5
perzentil_wbz <- 0.9

# Erstellung DataFrame
# Meldebestand
meldebestand <- mat_verlauf %>%
  filter(EinAutDatTyp =='geliefertAm') %>%
  select(ArtikelNr, BstDat,) %>%
  left_join(
    mat_verlauf %>%
    select(EinAusDat,EinAutDatTyp, `Artikel-Bezeichnung`,Menge, Bestand, cum_sum) %>%
    filter(Menge<0) , join_by(ArtikelNr, closest(BstDat >= EinAusDat))
  ) %>%
  drop_na() %>%
  group_by(`Artikel-Bezeichnung`) %>%
  summarize(Meldebestand_quantile = quantile(Bestand, probs=perzentil_meldebestand))

# Tägliche Nachfrage
tägl_nachfrage <- materials_b_tägl_menge %>%
  filter(EinAusDat <= "2023-06-12") %>%
  group_by(`Artikel-Bezeichnung`) %>%
  summarize(Nachfrage_quantile=quantile(tägl_menge, perzentil_nachfrage))

# WBZ in Tagen
wbz <- WBZ_Daten %>% 
  filter(EinAusDat <= "2023-06-12") %>%
  group_by(`Artikel-Bezeichnung`) %>% summarize(WBZ_quantile=quantile(WBZ, perzentil_wbz))

sicherheitsbestand <- materials_b %>% 
  filter(EinAusDat <= "2023-06-12") %>%
  group_by(`Artikel-Bezeichnung`) %>% summarize(ArtikelNr=first(ArtikelNr))
colnames(sicherheitsbestand) <- c("Artikel-Bezeichnung", "ArtikelNr")

sicherheitsbestand

#sicherheitsbestand <- inner_join(sicherheitsbestand, meldebestand, by="Artikel-Bezeichnung")
sicherheitsbestand <- inner_join(sicherheitsbestand, tägl_nachfrage, by="Artikel-Bezeichnung")
sicherheitsbestand <- inner_join(sicherheitsbestand, wbz, by="Artikel-Bezeichnung")

sicherheitsbestand

# Sicherheitsbestand berechnen
sicherheitsbestand <- sicherheitsbestand %>%
  mutate(nachf_in_WBZ_agg = as.numeric(Nachfrage_quantile * WBZ_quantile))
  #mutate(sicherheitsbestand = as.numeric(Meldebestand_quantile - Nachfrage_quantile * WBZ_quantile),

helper <- nachf_in_WBZ %>% 
  filter(EinAusDat <= "2023-06-12") %>%
  group_by(ArtikelNr) %>% summarize(nachf_in_WBZ=quantile(pick_cum_sum_between_orders, 0.5, na.rm=TRUE))

inner_join(sicherheitsbestand, helper, by="ArtikelNr")
```



```{r}
meldebestand <- mat_verlauf %>%
  filter(EinAutDatTyp =='geliefertAm') %>%
  select(ArtikelNr, BstDat,) %>%
  left_join(
    mat_verlauf %>%
    select(EinAusDat,EinAutDatTyp, `Artikel-Bezeichnung`,Menge, Bestand, cum_sum) %>%
    filter(Menge<0) , join_by(ArtikelNr, closest(BstDat >= EinAusDat))
  ) %>%
  drop_na()

meldebestand
```

# Neuer Ansatz
## Bestellpolitik
```{r}
perzentil_nachfrage <- 0.5
perzentil_wbz <- 0.0

# Nachfrage in minimaler WBZ
# Tägliche Nachfrage
tägl_nachfrage <- materials_b_tägl_menge %>%
  group_by(`Artikel-Bezeichnung`) %>%
  summarize(Nachfrage_quantil=quantile(tägl_menge, perzentil_nachfrage))

# WBZ in Tagen
wbz <- WBZ_Daten %>%
  group_by(`Artikel-Bezeichnung`) %>%
  summarize(WBZ_quantil=quantile(WBZ, perzentil_wbz),
            min_wbz = min(WBZ))

# Bestellpolitik: Optimale Losgröße als Nachfrage * minimale WBZ berechnen
bestellpolitik <- inner_join(tägl_nachfrage, wbz, by="Artikel-Bezeichnung")
bestellpolitik <- bestellpolitik %>% mutate(Losgröße.Empfehlung = as.numeric(Nachfrage_quantil*min_wbz)) 
bestellpolitik
```

## Bestandverlauf mit neuer Bestellpolitik
```{r}
alle_artikel <- data.frame()

for (mat in materials_group_b) {

  # Start-Parameter
  artikel <- mat
  artikelNr <- first(materials_b[materials_b$`Artikel-Bezeichnung` == artikel, "ArtikelNr"])
  
  min_wbz <- as.numeric(bestellpolitik[bestellpolitik$`Artikel-Bezeichnung`==artikel, "min_wbz"])
  losgröße <- as.numeric(bestellpolitik[bestellpolitik$`Artikel-Bezeichnung`==artikel, "Losgröße.Empfehlung"])
  startbestand <- losgröße
  
  nachfrage <- materials_b %>%
    filter(Menge < 0, `Artikel-Bezeichnung`==artikel, !is.na(EinAusDat)) %>%
    mutate(cum_sum=cumsum(Menge))
  
  # LOOP
  # Variablen für Loop
  bestand <- startbestand
  bestelldaten <- c()
  bestellmengen <- c()
  
  for (i in 1:nrow(nachfrage)) {
    row <- nth(nachfrage, i)
    
    bestand <- bestand + as.numeric(row$Menge)
    
    if (bestand <= losgröße) {
      # Bestellung auslösen
      bestelldaten <- append(bestelldaten, row$EinAusDat)
      
      # Bestellmenge = Losgröße plus was zusätzlich fehlt
      bestellmenge <- losgröße + (losgröße-bestand)
      bestellmengen <- append(bestellmengen, bestellmenge)
      bestand <- bestand + bestellmenge
    }
  }
  
  # Erste Zeile - Anfangswert
  anfang <- data.frame(ArtikelNr=artikelNr,
                       `Artikel-Bezeichnung`=artikel,
                       EinAusDat=min(nachfrage$EinAusDat, na.rm=TRUE),
                       EinAusDatTyp="geliefertAm",
                       BstDat=min(nachfrage$EinAusDat, na.rm=TRUE) - min_wbz,
                       Menge=startbestand,
                       Bestand=NA,
                       PjNr=NA,
                       PjInfo=NA,
                       ORGAKzl="Anfangsbestand",
                       klasse="Einkauf",
                       cum_sum=NA)
  
  # DataFrame mit allen Bestellungen
  mengen <- data.frame(ArtikelNr=artikelNr,
                       `Artikel-Bezeichnung`=artikel,
                       EinAusDat=bestelldaten + min_wbz,
                       EinAusDatTyp="geliefertAm",
                       BstDat=bestelldaten,
                       Menge=bestellmengen,
                       Bestand=NA,
                       PjNr=NA,
                       PjInfo=NA,
                       ORGAKzl="Neuer Einkauf",
                       klasse="Einkauf",
                       cum_sum=NA)
  
  colnames(anfang) <- colnames(nachfrage)
  colnames(mengen) <- colnames(nachfrage)
  
  # DataFrame zusammenführen, cum_sum (= Bestand) neu berechnen
  ges <- rbind(anfang, mengen, nachfrage) %>%
    arrange(EinAusDat) %>%
    mutate(cum_sum = cumsum(Menge))
  
  # Statistiken
  cat("\n\n", artikel)
  cat("\n----------------------------------")
  cat("\nLosgröße (= Meldebestand) = ", losgröße)
  cat("\nMinimale Wiederbeschaffungszeit = ", min_wbz)
  cat("\nAnzahl Bestellungen = ", nrow(mengen))
  cat("\nBestellungen MBG = ", nrow(materials_b %>% filter(Menge > 0, `Artikel-Bezeichnung`==artikel)))
  
  # DataFrame mit MBG Performance zusammenführen
  vergleich <- rbind(ges %>% mutate(Bestellpolitik="Empfehlung"),
                     materials_b %>% filter(`Artikel-Bezeichnung`==artikel) %>% mutate(cum_sum=cumsum(Menge), Bestellpolitik="MBG"))
  
  # DataFrame mit Gesamt-DF zusammenführen
  alle_artikel <- rbind(alle_artikel, vergleich %>% mutate(Artikel=artikel))
  
  # Individuelle Ergebnisse plotten
  #ggplot(data=vergleich) + geom_line(aes(x=EinAusDat,y=cum_sum, group=Bestellpolitik, color=Bestellpolitik))+ggtitle(artikel)
  
}

# Gesamtplot
ggplot(data=alle_artikel) + geom_line(aes(x=EinAusDat,y=cum_sum, group=Bestellpolitik, color=Bestellpolitik))+facet_wrap(~Artikel, nrow=3, scale="free_y")+ylab("Bestand")
```
## Quantifizierung der Einsparungen
```{r}
kosten <- data.frame(Artikel=materials_group_b,
                     Stückpreis=c(170, 36.58, 2.85*280/100, 9.39, 11.77, 28.1/500))

alle_artikel %>% group_by(Artikel, Bestellpolitik) %>% summarize(gesamtbestand=sum(cum_sum)) %>% pivot_wider(names_from=Bestellpolitik, values_from=gesamtbestand) %>%
  mutate(Unterschied=MBG - Empfehlung) %>%
  inner_join(kosten, by="Artikel") %>%
  mutate(Einsparungen=Unterschied*Stückpreis)
```


